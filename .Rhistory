"Mean Difference",
"95% CI",
"p-value",
"Adj. Mean Difference",
"Adj. 95% CI",
"Adj. p-value")
# Word Doc output
}
View(regressionDF)
adj.lm
temp_row
vs_subset <- ncd_merged_subset %>%
filter(!is.na(exit_viral_load_result))
for (s in unique(vs_subset$armR)) {
vs_arm_subset <- vs_subset %>% filter(armR == s)
N = nrow(vs_arm_subset)
# POISSON REGRESSIONS -------------------------------------------------------------
reg_vars <- data.frame(
var_name = c(
"bp_hi_exit",
"overwt_exit",
"a1c_hi_exit",
# "total_cholesterol_hi_exit",
"smokingR"),
var_label = c(
"Elevated BP",
"Overweight (BMI >= 25)",
"Elevated blood sugar (a1c >= 5.7)",
# "Elevated lipids (total cholesterol >= 200)",
"Current smoker [baseline]"))
regressionDF <- data.frame(
variable = character(),
rr = numeric(),
rr_ci = character(),
rr_p = numeric(),
adj.rr =  numeric(),
adj.rr_ci = character(),
adj.rr_p = character()
)
for (v in unique(reg_vars$var_name)) {
# Unadjusted
m <- geeglm(get(v) ~ exit_viral_load_suppressed,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se,
coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI
m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
# Adjusted for site, age, gender, smoking
if (v != "smokingR") {
adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
}
if (v == "smokingR") {
adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
}
adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se,
coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI
adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"],
as.numeric(round(m.rr, round_digits)),
paste0("(",
as.numeric(round(m.rr_ci, round_digits))[1],
",",
as.numeric(round(m.rr_ci, round_digits))[2],
")"),
as.numeric(round(m.p, p_digits)),
as.numeric(round(adj.rr, round_digits)),
paste0("(",
as.numeric(round(adj.rr_ci, round_digits))[1],
",",
as.numeric(round(adj.rr_ci, round_digits))[2],
")"),
as.numeric(round(adj.p, p_digits)))
regressionDF <- rbind(regressionDF, temp_row)
}
names(regressionDF) =
c("Variable",
"Relative Risk",
"95% CI",
"p-value",
"Adj. Relative Risk",
"Adj. 95% CI",
"Adj. p-value")
# LINEAR REGRESSIONS -----------------------------------------------------------------
lin_reg_vars <- data.frame(
var_name = c(
"sbp_mean_exit",
"dbp_mean_exit",
"bmi",
"hemoglobin_a1c_result",
"lipid_result"),
var_label = c(
"Systolic BP (mmHg)",
"Diastolic BP (mmHg)",
"BMI (kg/m^2)",
"Hemoglobin A1c (%)",
"Total cholesterol (mg/dL)")
)
regressionDF <- data.frame(
variable = character(),
rd = numeric(),
rd_ci = character(),
rd_p = numeric(),
adj.rd = character(),
adj.rd_ci = character(),
adj.rd_p = character()
)
for (v in unique(lin_reg_vars$var_name)) {
# Unadjusted
lm <- geeglm(get(v) ~ exit_viral_load_suppressed,
family = gaussian, data = vs_arm_subset,
id = hhid, corstr = "independence")
rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se,
coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # 95% CI
rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE",4]
# Adjusted for site, age, gender, smoking
adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
family = gaussian, data = vs_arm_subset,
id = hhid, corstr = "independence")
adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se,
coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"],
as.numeric(round(rd, round_digits)),
paste0("(",
as.numeric(round(rd_ci, round_digits))[1],
",",
as.numeric(round(rd_ci, round_digits))[2],
")"),
as.numeric(round(rd_p, p_digits)),
as.numeric(round(adj.rd, round_digits)),
paste0("(",
as.numeric(round(adj.rd_ci, round_digits))[1],
",",
as.numeric(round(adj.rd_ci, round_digits))[2],
")"),
as.numeric(round(adj.rd_p, p_digits)))
regressionDF <- rbind(regressionDF, temp_row)
}
names(regressionDF) =
c("Variable",
"Mean Difference",
"95% CI",
"p-value",
"Adj. Mean Difference",
"Adj. 95% CI",
"Adj. p-value")
# Word Doc output
}
ncd_merged_subset$smokingR
vs_subset <- ncd_merged_subset %>%
filter(!is.na(exit_viral_load_result))
v
vs_subset <- ncd_merged_subset %>%
filter(!is.na(exit_viral_load_result))
for (s in unique(vs_subset$armR)) {
vs_arm_subset <- vs_subset %>% filter(armR == s)
N = nrow(vs_arm_subset)
# POISSON REGRESSIONS -------------------------------------------------------------
reg_vars <- data.frame(
var_name = c(
"bp_hi_exit",
"overwt_exit",
"a1c_hi_exit",
#  "total_cholesterol_hi_exit",
"smokingR"),
var_label = c(
"Elevated BP",
"Overweight (BMI >= 25)",
"Elevated blood sugar (a1c >= 5.7)",
#   "Elevated lipids (total cholesterol >= 200)",
"Current smoker [baseline]"))
regressionDF <- data.frame(
variable = character(),
rr = numeric(),
rr_ci = character(),
rr_p = numeric(),
adj.rr =  numeric(),
adj.rr_ci = character(),
adj.rr_p = character()
)
for (v in unique(reg_vars$var_name)) {
# Unadjusted
m <- geeglm(get(v) ~ exit_viral_load_suppressed,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se,
coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI
m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
# Adjusted for site, age, gender, smoking
if (v != "smokingR") {
adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
}
if (v == "smokingR") {
adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
}
adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se,
coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI
adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"],
as.numeric(round(m.rr, round_digits)),
paste0("(",
as.numeric(round(m.rr_ci, round_digits))[1],
",",
as.numeric(round(m.rr_ci, round_digits))[2],
")"),
as.numeric(round(m.p, p_digits)),
as.numeric(round(adj.rr, round_digits)),
paste0("(",
as.numeric(round(adj.rr_ci, round_digits))[1],
",",
as.numeric(round(adj.rr_ci, round_digits))[2],
")"),
as.numeric(round(adj.p, p_digits)))
regressionDF <- rbind(regressionDF, temp_row)
}
names(regressionDF) =
c("Variable",
"Relative Risk",
"95% CI",
"p-value",
"Adj. Relative Risk",
"Adj. 95% CI",
"Adj. p-value")
# Word Doc output
ft <- flextable(regressionDF) %>%
colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
add_header_row(values = c(paste0(s, " (n = " , N, ")"), "Baseline Analysis", "Adjusted Analysis"),
top = T, colwidths = c(1, 3, 3)) %>%
width(width = 1.1) %>%
width(j = 1, width = 2.5) %>%
theme_vanilla() %>%
vline(j = c(1, 4), border = fp_border_default(), part = "all") %>%
align(i =1, align = "center", part = "header")
flextable_to_rmd(ft)
# LINEAR REGRESSIONS -----------------------------------------------------------------
lin_reg_vars <- data.frame(
var_name = c(
"sbp_mean_exit",
"dbp_mean_exit",
"bmi",
"hemoglobin_a1c_result",
"lipid_result"),
var_label = c(
"Systolic BP (mmHg)",
"Diastolic BP (mmHg)",
"BMI (kg/m^2)",
"Hemoglobin A1c (%)",
"Total cholesterol (mg/dL)")
)
regressionDF <- data.frame(
variable = character(),
rd = numeric(),
rd_ci = character(),
rd_p = numeric(),
adj.rd = character(),
adj.rd_ci = character(),
adj.rd_p = character()
)
for (v in unique(lin_reg_vars$var_name)) {
# Unadjusted
lm <- geeglm(get(v) ~ exit_viral_load_suppressed,
family = gaussian, data = vs_arm_subset,
id = hhid, corstr = "independence")
rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se,
coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # 95% CI
rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE",4]
# Adjusted for site, age, gender, smoking
adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
family = gaussian, data = vs_arm_subset,
id = hhid, corstr = "independence")
adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se,
coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"],
as.numeric(round(rd, round_digits)),
paste0("(",
as.numeric(round(rd_ci, round_digits))[1],
",",
as.numeric(round(rd_ci, round_digits))[2],
")"),
as.numeric(round(rd_p, p_digits)),
as.numeric(round(adj.rd, round_digits)),
paste0("(",
as.numeric(round(adj.rd_ci, round_digits))[1],
",",
as.numeric(round(adj.rd_ci, round_digits))[2],
")"),
as.numeric(round(adj.rd_p, p_digits)))
regressionDF <- rbind(regressionDF, temp_row)
}
names(regressionDF) =
c("Variable",
"Mean Difference",
"95% CI",
"p-value",
"Adj. Mean Difference",
"Adj. 95% CI",
"Adj. p-value")
# Word Doc output
ft <- flextable(regressionDF) %>%
colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
add_header_row(values = c(paste0(s, " (n = " , N, ")"), "Baseline Analysis", "Adjusted Analysis"),
top = T, colwidths = c(1, 3, 3)) %>%
width(width = 1.1) %>%
width(j = 1, width = 2.5) %>%
theme_vanilla()  %>%
vline(j = c(1, 4), border = fp_border_default(), part = "all") %>%
align(i =1, align = "center", part = "header")
flextable_to_rmd(ft)
}
View(regressionDF)
vs_subset <- ncd_merged_subset %>%
filter(!is.na(exit_viral_load_result))
for (s in unique(vs_subset$armR)) {
vs_arm_subset <- vs_subset %>% filter(armR == s)
N = nrow(vs_arm_subset)
# POISSON REGRESSIONS -------------------------------------------------------------
reg_vars <- data.frame(
var_name = c(
"bp_hi_exit",
"overwt_exit",
"a1c_hi_exit",
#  "total_cholesterol_hi_exit",
"smokingR"),
var_label = c(
"Elevated BP",
"Overweight (BMI >= 25)",
"Elevated blood sugar (a1c >= 5.7)",
#   "Elevated lipids (total cholesterol >= 200)",
"Current smoker [baseline]"))
regressionDF <- data.frame(
variable = character(),
rr = numeric(),
rr_ci = character(),
rr_p = numeric(),
adj.rr =  numeric(),
adj.rr_ci = character(),
adj.rr_p = character()
)
for (v in unique(reg_vars$var_name)) {
# Unadjusted
m <- geeglm(get(v) ~ exit_viral_load_suppressed,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se,
coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI
m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
# Adjusted for site, age, gender, smoking
if (v != "smokingR") {
adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
}
if (v == "smokingR") {
adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
}
adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se,
coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI
adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"],
as.numeric(round(m.rr, round_digits)),
paste0("(",
as.numeric(round(m.rr_ci, round_digits))[1],
",",
as.numeric(round(m.rr_ci, round_digits))[2],
")"),
as.numeric(round(m.p, p_digits)),
as.numeric(round(adj.rr, round_digits)),
paste0("(",
as.numeric(round(adj.rr_ci, round_digits))[1],
",",
as.numeric(round(adj.rr_ci, round_digits))[2],
")"),
as.numeric(round(adj.p, p_digits)))
regressionDF <- rbind(regressionDF, temp_row)
}
}
View(regressionDF)
v
m
s
rm(list=ls())
# Load packages
package.list <- c("plyr", "dplyr", "tidyr", "magrittr", "data.table", "ggplot2",
"janitor", "tables", "flextable", # table formatting
"geepack", "sandwich", # regression analysis
"ggpubr"
)
# new.packages <- package.list[!(package.list %in% installed.packages()[,"Package"])]
# if(length(new.packages)) install.packages(new.packages)
invisible(lapply(package.list, library, character.only = TRUE))
# Load data
dir <- "C:/Users/msahu/Documents/Other_Research/DO_ART_NCD/"
in_dir <- paste0(dir, "0_data/3_cleaned_data/")
# Subset to South Africa only!!
# NOTE: we combine the community and hybrid arm (community follow-up), compared to clinic
ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>%
filter(country == "South Africa") %>%
mutate(site = factor (site,
levels = c("HSRC",
"AHRI"))) %>%
mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
arm == "Community arm" ~ "Community follow-up",
arm == "Hybrid arm" ~ "Community follow-up" ))
round_digits = 2
p_digits = 3
# WARNING that chunks build on each other! Can't run individually
vs_subset <- ncd_merged_subset %>%
filter(!is.na(exit_viral_load_result))
for (s in unique(vs_subset$armR)) {
vs_arm_subset <- vs_subset %>% filter(armR == s)
N = nrow(vs_arm_subset)
# POISSON REGRESSIONS -------------------------------------------------------------
reg_vars <- data.frame(
var_name = c(
"bp_hi_exit",
"overwt_exit",
"a1c_hi_exit",
#  "total_cholesterol_hi_exit",
"smokingR"),
var_label = c(
"Elevated BP",
"Overweight (BMI >= 25)",
"Elevated blood sugar (a1c >= 5.7)",
#   "Elevated lipids (total cholesterol >= 200)",
"Current smoker [baseline]"))
regressionDF <- data.frame(
variable = character(),
rr = numeric(),
rr_ci = character(),
rr_p = numeric(),
adj.rr =  numeric(),
adj.rr_ci = character(),
adj.rr_p = character()
)
for (v in unique(reg_vars$var_name)) {
# Unadjusted
m <- geeglm(get(v) ~ exit_viral_load_suppressed,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se,
coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI
m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
# Adjusted for site, age, gender, smoking
if (v != "smokingR") {
adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
}
if (v == "smokingR") {
adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR,
family = poisson, data = vs_arm_subset,
id = hhid, corstr = "independence")
}
adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se,
coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI
adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"],
as.numeric(round(m.rr, round_digits)),
paste0("(",
as.numeric(round(m.rr_ci, round_digits))[1],
",",
as.numeric(round(m.rr_ci, round_digits))[2],
")"),
as.numeric(round(m.p, p_digits)),
as.numeric(round(adj.rr, round_digits)),
paste0("(",
as.numeric(round(adj.rr_ci, round_digits))[1],
",",
as.numeric(round(adj.rr_ci, round_digits))[2],
")"),
as.numeric(round(adj.p, p_digits)))
regressionDF <- rbind(regressionDF, temp_row)
}
}
View(regressionDF)
unique(vs_subset$armR)
unique(vs_subset$arm)
