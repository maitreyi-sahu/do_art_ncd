---
title: "DO ART NCD Tables & Figures"
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    reference_docx: word_styles.docx

---

```{r setup, include = F, echo = F, warning = F, message = F}

rm(list=ls())

# Load packages

library(dplyr)
library(tidyr)
library(data.table)
library(ggplot2)

# Table formatting packages
library(janitor)
library(tables)
library(flextable)

# Regression packages
library(sandwich)

# Load data

dir <- "C:/Users/msahu/Documents/Other_Research/DO_ART_NCD/"
in_dir <- paste0(dir, "0_data/3_cleaned_data/")

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds"))

ncd_noHybrid <- ncd_merged_subset %>% filter(arm!= "Hybrid arm")
round_digits = 2
p_digits = 3

# WARNING that chunks build on each other! Can't run individually

```

# Main paper tables 

+ Table 1: Descriptive statistics of cardiovascular risk in the DO ART study, by trial arm and gender
+ Table 2: Poisson + linear regressions for community delivery of HIV care compared with clinic-based care, and including VS
+ Table 3: Poisson + linear regressions with VS as predictor [NON-RANDOMIZED ANALYSIS]
+ Table 4: Poisson + linear regressions, stratified by country

### Page Break

## Table 1: Descriptive statistics of cardiovascular risk in the DO ART study, by trial arm and gender (N = 1315)

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# Set up --------------------------------------------------------------------------

headings <- data.frame(
  section = c("A", "B", "C"),
  title = c( "", 
             "ii) Lifestyle and other risk",
              "iii) Cardiovascular Risk")
)

# A) Demographics
A_vars = c(
  "age_cat",
  "genderR"
  )
A_var_labels = c(
  "Age",
  "Gender"
  )

# B) Lifestyle and Other Risk

B_vars = c(  
  "smoking_cat",
  "exer_cat",
  "veg_cat",
  "stroke_cat")
B_var_labels = c(
  "Smoking Status  \n [Baseline]",
  "Days of exercise (per week) \n [Endline]",
  "Vegetable intake \n [Endline]",
   "Prior stroke or heart attack  \n [Endline]")


# C) Cardiovascular risk
C_vars = c(
  "bp_cat_exit", 
  "bmi_cat_exit", 
  "a1c_cat_exit", 
  "total_cholesterol_exit",
  "who_cvd_risk_exit")
C_var_labels = c(
  "Blood pressure \n [Endline]",
   "BMI (kg/m^2) \n [Endline]",
   "Hemoglobin A1C (%) \n [Endline]",
   "Total cholesterol (mg/dL) \n [Endline]",
   "10-year CVD risk score \n [Endline]")

table_vars <- data.frame(
  
  var_name = c(A_vars, B_vars, C_vars),

  var_label = c(A_var_labels, B_var_labels, C_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(A_vars) ~ "A",
      var_name %in% c(B_vars) ~ "B",
      var_name %in% c(C_vars) ~ "C")
    )
  
# Descriptive Proportion Table ----------------------------------------------------

col_headings_freq <- c(
  "Category",
  "Clinic Arm \n n (%)", 
  "Community Arm \n n (%)",
  "Hybrid Arm \n n (%)",
  "Women \n n (%)",
  "Men \n n (%)",
  "Total \n n (%)"
  )

for (i in unique(headings$section)) {
  
  table_subset <- table_vars[table_vars$section==i, ]
  
  tableDF <- data.frame(
        variable = character(),
        category = character(),
        clinic_arm = character(),
        community_arm = character(),
        hybrid_arm = character(),
        Women = character(),
        Men = character(),
        Total = character()
    )
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset
    
    temp1 <- data %>% 
      
      # Format table using Janitor package 
      tabyl(!!sym(v), arm) %>% 
      adorn_totals(where = "col") %>% 
      adorn_percentages(denominator = "col") %>% 
      adorn_pct_formatting(digits = 0, affix_sign = TRUE) %>% 
      adorn_ns(position = "front") %>%
      as.data.frame() %>% 
      
      # Clean up headers
      rename(category = 1,
             clinic_arm = `Clinic arm`,
             community_arm = `Community arm`,
             hybrid_arm = `Hybrid arm`) %>% 
      mutate(variable = table_vars[table_vars$var_name == v, "var_label"] ) %>% 
      select(variable, category, clinic_arm, community_arm, hybrid_arm, Total)
    
    if (v != "genderR") {
    
    temp2 <- data %>% 
      
      # Format table using Janitor package 
      tabyl(!!sym(v), genderR) %>% 
      adorn_totals(where = "col") %>% 
      adorn_percentages(denominator = "col") %>% 
      adorn_pct_formatting(digits = 0, affix_sign = TRUE) %>% 
      adorn_ns(position = "front") %>%
      as.data.frame() %>% 
      
      # Clean up headers
      select(Women, Men)
    
    }
    
    if (v == "genderR") {
    
    temp2 <- data.frame(
      Women = "--",
      Men = "--"
    )
    
    }
  
  temp <- cbind(temp1, temp2) %>% 
    select(variable, category, clinic_arm, community_arm, hybrid_arm, Women, Men, Total)
      
  tableDF <- rbind(tableDF, temp)
  
  }
  
  # Flextable

ft <- flextable(tableDF) %>%
   
  delete_part(part = "header") %>%
  add_header_row(values = c(headings[headings$section == i, "title"], col_headings_freq))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  merge_v(j = "variable") %>%
  width(width = 1.25) %>%
  theme_vanilla() %>% 
  vline(j = c(2, 5, 7), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

rm(temp, temp1, temp2)  
}

```


### Page Break

## Table 2. Cardiovascular risk for community delivery of HIV care compared with clinic-based care (N = 873).

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

results_list <- vector(mode = "list")  # BIND RESULTS FOR PLOT

# Poisson REGRESSIONS --------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
    "total_cholesterol_hi_exit"),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
    "Elevated lipids (total cholesterol >= 200)"))
  

regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character(),
        ext.rr = character(),
        ext.rr_ci = character(), 
        ext.rr_p = character() 
    )

plotDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character(),
        ext.rr = character(),
        ext.rr_ci = character(), 
        ext.rr_p = character() 
    )
 
for (v in unique(reg_vars$var_name)) {
  
  # Adjusted for site only
  m <- glm(get(v) ~ arm + site, 
           data = ncd_noHybrid, 
           family = quasipoisson(link = "log"))
  m.rr <- exp(coef(m)[["armCommunity arm"]]) # Relative Risk
  m.se <- sqrt(diag( vcovHC(m, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  m.rr_ci <- exp(c(coef(m)[["armCommunity arm"]] - qnorm(0.975)*m.se, 
               coef(m)[["armCommunity arm"]] + qnorm(0.975)*m.se)) # RR: 95% CI with robust SE
  m.p <- 2*pnorm(abs(coef(m)[["armCommunity arm"]]/m.se), lower.tail = F)

  # Adjusted for site, age, gender, smoking 
  
  if (v=="who_cvd_hi_exit") { # 3-way interaction term for cvd risk only
  
  adj.m <- glm(get(v) ~ arm + site + age_cat * genderR * smoking_status, 
              data = ncd_noHybrid,
              family = quasipoisson(link = "log")) }
  
  if (v!="who_cvd_hi_exit") {
  
  adj.m <- glm(get(v) ~ arm + site + age_cat + genderR + smoking_status, 
              data = ncd_noHybrid,
              family = quasipoisson(link = "log")) }
  
  adj.rr <- exp(coef(adj.m)[["armCommunity arm"]]) # Relative Risk
  adj.se <- sqrt(diag(vcovHC(adj.m, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  adj.rr_ci <- exp(c(coef(adj.m)[["armCommunity arm"]] - qnorm(0.975)*adj.se, 
                 coef(adj.m)[["armCommunity arm"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- 2*pnorm(abs(coef(adj.m)[["armCommunity arm"]]/adj.se), lower.tail = F)

  # Adjusted for VS and site, age, gender, smoking 
  
   if (v=="who_cvd_hi_exit") { # 3-way interaction term for cvd risk only
     
  ext.m <- glm( get(v) ~ arm + site + age_cat * genderR * smoking_status + exit_viral_load_suppressedR, 
              data = ncd_noHybrid,
              family = quasipoisson(link = "log")) }
  
  if (v!="who_cvd_hi_exit") { # 3-way interaction term for cvd risk only
     
  ext.m <- glm( get(v) ~ arm + site + age_cat + genderR + smoking_status + exit_viral_load_suppressedR, 
              data = ncd_noHybrid,
              family = quasipoisson(link = "log")) }
  
  ext.rr <- exp(coef(ext.m)[["armCommunity arm"]]) # Relative Risk
  ext.se <- sqrt(diag(vcovHC(ext.m, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  ext.rr_ci <- exp(c(coef(ext.m)[["armCommunity arm"]] - qnorm(0.975)*ext.se, 
                 coef(ext.m)[["armCommunity arm"]] + qnorm(0.975)*ext.se)) # RR: 95% CI with robust SE
  ext.p <- 2*pnorm(abs(coef(ext.m)[["armCommunity arm"]]/ext.se), lower.tail = F)
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.numeric(round(m.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(m.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(m.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(m.p, p_digits)),
                as.numeric(round(adj.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.p, p_digits)),
                as.numeric(round(ext.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(ext.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(ext.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(ext.p, p_digits))
                )
  
  regressionDF <- rbind(regressionDF, temp_row)
  
  temp_row_plot <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.numeric(m.rr), 
                as.numeric(m.rr_ci[1]),
                as.numeric(m.rr_ci[2]),
                as.numeric(round(m.p, p_digits)),
                as.numeric(adj.rr), 
                as.numeric(adj.rr_ci[1]),
                as.numeric(adj.rr_ci[2]),
                as.numeric(round(adj.p, p_digits)),
                as.numeric(ext.rr), 
                as.numeric(ext.rr_ci[1]),
                as.numeric(ext.rr_ci[2]),
                as.numeric(round(ext.p, p_digits))
               )
  
  plotDF <- rbind(plotDF, temp_row_plot)
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value",
    "Ext. Relative Risk",
    "Ext. 95% CI",
    "Ext. p-value")

names(plotDF) =
  c("Variable",
    "main.estimate",
    "main.lower",
    "main.upper",
    "main.p",
    "adj.estimate",
    "adj.lower",
    "adj.upper",
    "adj.p",
    "ext.estimate",
    "ext.lower",
    "ext.upper",
    "ext.p")

plotDF <-  plotDF %>% 
    gather(label, value, 2:13) %>% 
    separate(label, into = c("model", "estimate")) %>% 
    mutate(value = as.numeric(value)) %>% 
    spread(key = estimate, value = value) %>% 
    mutate(country = "Overall",
           outcome = "relative_risk")

results_list[[length(results_list) + 1]] <- plotDF
names(results_list)[length(results_list)] <- "rr.Overall"

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Baseline Analysis", "Adjusted Analysis", "Extended Analysis \n (including Viral Suppression)"), 
                 top = T, colwidths = c(1, 3, 3, 3)) %>% 
  width(width = .95) %>%
  width(j = 1, width = 1.3) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS --------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic BP (mmHg)",
    "Diastolic BP (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character(), 
        ext.rd = character(),
        ext.rd_ci = character(), 
        ext.rd_p = character()
    )

plotDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_lower = numeric(),
        rr_upper = numeric(),
        rr_p = numeric(),
        adj.rr = numeric(),
        adj.rr_lower = numeric(),
        adj.rr_upper = numeric(),
        adj.rr_p = numeric(),
        ext.rr = numeric(),
        ext.rr_lower = numeric(),
        ext.rr_upper = numeric(),
        ext.rr_p = numeric()
    )
 
for (v in unique(lin_reg_vars$var_name)) {
  
  # Adjusted for site only
  lm <- lm(get(v) ~ arm + site, data = ncd_noHybrid)
  rd <- coef(lm)[["armCommunity arm"]] # Risk Difference
  lm.se <- sqrt(diag( vcovHC(lm, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  rd_ci <- c(coef(lm)[["armCommunity arm"]] - qnorm(0.975)*lm.se, 
               coef(lm)[["armCommunity arm"]] + qnorm(0.975)*lm.se) # RD: 95% CI with robust SE
  rd_p <- 2*pnorm(abs(coef(lm)[["armCommunity arm"]]/lm.se), lower.tail = F)

  # Adjusted for site, age, gender, smoking (no 3-way interaction effects)
  adj.lm <- lm(get(v) ~ arm + site + age_cat + genderR + smoking_status, 
              data = ncd_noHybrid)
  adj.rd <- coef(adj.lm)[["armCommunity arm"]] # Risk Difference
  adj.lm.se <- sqrt(diag(vcovHC(adj.lm, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  adj.rd_ci <- c(coef(adj.lm)[["armCommunity arm"]] - qnorm(0.975)*adj.lm.se, 
                 coef(adj.lm)[["armCommunity arm"]] + qnorm(0.975)*adj.lm.se) # RD: 95% CI with robust SE
  adj.rd_p <- 2*pnorm(abs(coef(adj.lm)[["armCommunity arm"]]/adj.lm.se), lower.tail = F)

  # Adjusted for VS and site, age, gender, smoking (with 3-way interaction effects for all vars)
  ext.lm <- lm(get(v) ~ arm + site + age_cat + genderR + smoking_status + exit_viral_load_suppressedR, 
              data = ncd_noHybrid)
  ext.rd <- coef(ext.lm)[["armCommunity arm"]] # Risk Difference
  ext.lm.se <- sqrt(diag(vcovHC(ext.lm, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  ext.rd_ci <- c(coef(ext.lm)[["armCommunity arm"]] - qnorm(0.975)*ext.lm.se, 
                 coef(ext.lm)[["armCommunity arm"]] + qnorm(0.975)*ext.lm.se) # RD: 95% CI with robust SE
  ext.rd_p <- 2*pnorm(abs(coef(ext.lm)[["armCommunity arm"]]/ext.lm.se), lower.tail = F)

  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.numeric(round(rd, round_digits)), 
                paste0("(",
                       as.numeric(round(rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(rd_p, p_digits)),
                as.numeric(round(adj.rd, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.rd_p, p_digits)),
                as.numeric(round(ext.rd, round_digits)), 
                paste0("(",
                       as.numeric(round(ext.rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(ext.rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(ext.rd_p, p_digits))
                )
  
  regressionDF <- rbind(regressionDF, temp_row)
  
  temp_row_plot <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.numeric(rd), 
                as.numeric(rd_ci[1]),
                as.numeric(rd_ci[2]),
                as.numeric(round(rd_p, p_digits)),
                as.numeric(adj.rd), 
                as.numeric(adj.rd_ci[1]),
                as.numeric(adj.rd_ci[2]),
                as.numeric(round(adj.rd_p, p_digits)),
                as.numeric(ext.rd), 
                as.numeric(ext.rd_ci[1]),
                as.numeric(ext.rd_ci[2]),
                as.numeric(round(ext.rd_p, p_digits))
               )
  
  plotDF <- rbind(plotDF, temp_row_plot)
}
  
names(regressionDF) =
  c("Variable",
    "Risk Difference",
    "95% CI",
    "p-value",
    "Adj. Risk Difference",
    "Adj. 95% CI",
    "Adj. p-value",
    "Ext. Risk Difference",
    "Ext. 95% CI",
    "Ext. p-value")

names(plotDF) =
  c("Variable",
    "main.estimate",
    "main.lower",
    "main.upper",
    "main.p",
    "adj.estimate",
    "adj.lower",
    "adj.upper",
    "adj.p",
    "ext.estimate",
    "ext.lower",
    "ext.upper",
    "ext.p")

plotDF <-  plotDF %>% 
    gather(label, value, 2:13) %>% 
    separate(label, into = c("model", "estimate")) %>% 
    mutate(value = as.numeric(value)) %>% 
    spread(key = estimate, value = value) %>% 
    mutate(country = "Overall",
           outcome = "risk_difference")

results_list[[length(results_list) + 1]] <- plotDF
names(results_list)[length(results_list)] <- "rd.Overall"

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Baseline Analysis", "Adjusted Analysis", "Extended Analysis \n (including Viral Suppression)"), 
                 top = T, colwidths = c(1, 3, 3, 3)) %>% 
  width(width = .95) %>%
  width(j = 1, width = 1.3) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

```

&nbsp;

+ Relative risk is estimated using a quasipoisson model with robust SEs (and log link).
+ Risk difference is estimated using a linear model with robust SEs.
+ Baseline model adjusts for site only
+ Adjusted models includes site, age, smoking and gender.
+ Extended model includes model endline viral suppression [binary] plus all adjustment variables

### Page Break

## Table 3. Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline (N = 1315).

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# POISSON REGRESSIONS --------------------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
    "total_cholesterol_hi_exit"),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
    "Elevated lipids (total cholesterol >= 200)"))
  

regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character() 
    )
 
for (v in unique(reg_vars$var_name)) {
  
  # Adjusted for site only
  
  m <- glm(get(v) ~ site + exit_viral_load_suppressed, 
           data = ncd_merged_subset, 
           family = quasipoisson(link = "log"))
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  m.se <- sqrt(diag( vcovHC(m, type = "HC0")))["exit_viral_load_suppressedTRUE"] # Robust SE (unexponentiated)
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se, 
               coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI with robust SE
  m.p <- 2*pnorm(abs(coef(m)[["exit_viral_load_suppressedTRUE"]]/m.se), lower.tail = F)
  
  # Adjusted for site, age, gender, smoking 
  
   if (v=="who_cvd_hi_exit") { # 3-way interaction term for cvd risk only
     
  adj.m <- glm( get(v) ~ site + age_cat * genderR * smoking_status + exit_viral_load_suppressed, 
              data = ncd_merged_subset,
              family = quasipoisson(link = "log")) }
  
  if (v!="who_cvd_hi_exit") { # 3-way interaction term for cvd risk only
     
  adj.m <- glm( get(v) ~ site + age_cat + genderR + smoking_status + exit_viral_load_suppressed, 
              data = ncd_merged_subset,
              family = quasipoisson(link = "log")) }
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- sqrt(diag(vcovHC(adj.m, type = "HC0")))["exit_viral_load_suppressedTRUE"] # Robust SE (unexponentiated)
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                 coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- 2*pnorm(abs(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]/adj.se), lower.tail = F)

  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.numeric(round(m.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(m.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(m.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(m.p, p_digits)),
                as.numeric(round(adj.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Baseline Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -------------------------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic blood pressure (mmHg)",
    "Diastolic blood pressure (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() 
    )
 
for (v in unique(lin_reg_vars$var_name)) {
  
  # Adjusted for site only
  lm <- lm(get(v) ~ site + exit_viral_load_suppressed, data = ncd_merged_subset)
  rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Risk Difference
  lm.se <- sqrt(diag( vcovHC(lm, type = "HC0")))["exit_viral_load_suppressedTRUE"] # Robust SE (unexponentiated)
  rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se, 
               coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # RD: 95% CI with robust SE
  rd_p <- 2*pnorm(abs(coef(lm)[["exit_viral_load_suppressedTRUE"]]/lm.se), lower.tail = F)

  # Adjusted for site, age, gender, smoking (with 3-way interaction effects for all vars)
  adj.lm <- lm(get(v) ~ site + age_cat + genderR + smoking_status + exit_viral_load_suppressed, 
              data = ncd_merged_subset)
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Risk Difference
  adj.lm.se <- sqrt(diag(vcovHC(adj.lm, type = "HC0")))["exit_viral_load_suppressedTRUE"] # Robust SE (unexponentiated)
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                 coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # RD: 95% CI with robust SE
  adj.rd_p <- 2*pnorm(abs(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]]/adj.lm.se), lower.tail = F)

  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.numeric(round(rd, round_digits)), 
                paste0("(",
                       as.numeric(round(rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(rd_p, p_digits)),
                as.numeric(round(adj.rd, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.rd_p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)
}
  
names(regressionDF) =
  c("Variable",
    "Risk Difference",
    "95% CI",
    "p-value",
    "Adj. Risk Difference",
    "Adj. 95% CI",
    "Adj. p-value")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Baseline Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft
```


&nbsp;

+ Relative risk is estimated using a quasipoisson model with robust SEs (and log link).
+ Risk difference is estimated using a linear model with robust SEs.
+ This analysis does NOT include trial arm.
+ Baseline model adjusts for site only; adjusted models include site, age, smoking, and gender

### Page Break

# Table 4: Cardiovascular risk for community delivery of HIV care compared with clinic-based care, stratified by country


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

for (s in unique(ncd_noHybrid$country)) {

ncd_country_subset <- ncd_noHybrid %>% filter(country == s)  

N = nrow(ncd_country_subset)

# POISSON REGRESSIONS -------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
    "total_cholesterol_hi_exit"),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
    "Elevated lipids (total cholesterol >= 200)"))
  

regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr =  numeric(),
        adj.rr_ci = character(), 
        adj.rr_p = character(),
        ext.rr =  numeric(),
        ext.rr_ci = character(), 
        ext.rr_p = character() 
    )

plotDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_lower = numeric(),
        rr_upper = numeric(),
        rr_p = numeric(),
        adj.rr = numeric(),
        adj.rr_lower = numeric(),
        adj.rr_upper = numeric(),
        adj.rr_p = numeric(),
        ext.rr = numeric(),
        ext.rr_lower = numeric(),
        ext.rr_upper = numeric(),
        ext.rr_p = numeric()
    )
 
for (v in unique(reg_vars$var_name)) {
  
  # Adjusted for site only
  m <- glm(get(v) ~ arm, 
           data = ncd_country_subset, 
           family = quasipoisson(link = "log"))
  m.rr <- exp(coef(m)[["armCommunity arm"]]) # Relative Risk
  m.se <- sqrt(diag( vcovHC(m, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  m.rr_ci <- exp(c(coef(m)[["armCommunity arm"]] - qnorm(0.975)*m.se, 
               coef(m)[["armCommunity arm"]] + qnorm(0.975)*m.se)) # RR: 95% CI with robust SE
  m.p <- 2*pnorm(abs(coef(m)[["armCommunity arm"]]/m.se), lower.tail = F)

  # Adjusted for site, age, gender, smoking 
  
  if (v=="who_cvd_hi_exit") { # 3-way interaction term for cvd risk only
  
  adj.m <- glm(get(v) ~ arm + age_cat * genderR * smoking_status, 
              data = ncd_country_subset,
              family = quasipoisson(link = "log")) 
  }
  
  if (v!="who_cvd_hi_exit") {
  
  adj.m <- glm(get(v) ~ arm + age_cat + genderR + smoking_status, 
              data = ncd_country_subset,
              family = quasipoisson(link = "log")) 
  }
  
  adj.rr <- exp(coef(adj.m)[["armCommunity arm"]]) # Relative Risk
  adj.se <- sqrt(diag(vcovHC(adj.m, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  adj.rr_ci <- exp(c(coef(adj.m)[["armCommunity arm"]] - qnorm(0.975)*adj.se, 
                 coef(adj.m)[["armCommunity arm"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- 2*pnorm(abs(coef(adj.m)[["armCommunity arm"]]/adj.se), lower.tail = F)

  # Adjusted for VS, site, age, gender, smoking 
  
  if (v=="who_cvd_hi_exit") { # 3-way interaction term for cvd risk only
  
  ext.m <- glm(get(v) ~ arm + age_cat * genderR * smoking_status + exit_viral_load_suppressedR, 
              data = ncd_country_subset,
              family = quasipoisson(link = "log")) 
  }
  
  if (v!="who_cvd_hi_exit") {
  
  ext.m <- glm(get(v) ~ arm + age_cat + genderR + smoking_status + exit_viral_load_suppressedR, 
              data = ncd_country_subset,
              family = quasipoisson(link = "log")) 
  }
  
  ext.rr <- exp(coef(ext.m)[["armCommunity arm"]]) # Relative Risk
  ext.se <- sqrt(diag(vcovHC(ext.m, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  ext.rr_ci <- exp(c(coef(ext.m)[["armCommunity arm"]] - qnorm(0.975)*ext.se, 
                 coef(ext.m)[["armCommunity arm"]] + qnorm(0.975)*ext.se)) # RR: 95% CI with robust SE
  ext.p <- 2*pnorm(abs(coef(ext.m)[["armCommunity arm"]]/ext.se), lower.tail = F)
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.numeric(round(m.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(m.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(m.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(m.p, p_digits)),
                as.numeric(round(adj.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.p, p_digits)),
                as.numeric(round(ext.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(ext.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(ext.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(ext.p, p_digits)))
  
  temp_row_plot <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.numeric(m.rr), 
                as.numeric(m.rr_ci[1]),
                as.numeric(m.rr_ci[2]),
                as.numeric(round(m.p, p_digits)),
                as.numeric(adj.rr), 
                as.numeric(adj.rr_ci[1]),
                as.numeric(adj.rr_ci[2]),
                as.numeric(round(adj.p, p_digits)),
                as.numeric(ext.rr), 
                as.numeric(ext.rr_ci[1]),
                as.numeric(ext.rr_ci[2]),
                as.numeric(round(ext.p, p_digits))
               )
  
  plotDF <- rbind(plotDF, temp_row_plot)
  
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value",
    "Ext. Relative Risk",
    "Ext. 95% CI",
    "Ext. p-value")

names(plotDF) =
  c("Variable",
    "main.estimate",
    "main.lower",
    "main.upper",
    "main.p",
    "adj.estimate",
    "adj.lower",
    "adj.upper",
    "adj.p",
    "ext.estimate",
    "ext.lower",
    "ext.upper",
    "ext.p")

plotDF <-  plotDF %>% 
    gather(label, value, 2:13) %>% 
    separate(label, into = c("model", "estimate")) %>% 
    mutate(value = as.numeric(value)) %>% 
    spread(key = estimate, value = value) %>% 
    mutate(country = s,
           outcome = "relative_risk")

results_list[[length(results_list) + 1]] <- plotDF
names(results_list)[length(results_list)] <- paste("rr",s, sep = ".")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c(paste0(s, " (n = " , N, ")"), "Baseline Analysis", "Adjusted Analysis", "Extended Analysis \n (including Viral Suppression)"), 
                 top = T, colwidths = c(1, 3, 3, 3)) %>% 
  width(width = .95) %>%
  width(j = 1, width = 1.3) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

flextable_to_rmd(ft) 

# LINEAR REGRESSIONS -----------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic BP (mmHg)",
    "Diastolic BP (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() ,
        ext.rd = character(),
        ext.rd_ci = character(), 
        ext.rd_p = character()
    )

plotDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_lower = numeric(),
        rr_upper = numeric(),
        rr_p = numeric(),
        adj.rr = numeric(),
        adj.rr_lower = numeric(),
        adj.rr_upper = numeric(),
        adj.rr_p = numeric(),
        ext.rr = numeric(),
        ext.rr_lower = numeric(),
        ext.rr_upper = numeric(),
        ext.rr_p = numeric()
    )
 
for (v in unique(lin_reg_vars$var_name)) {
  
  # Unadjusted
  lm <- lm(get(v) ~ arm, data = ncd_country_subset)
  rd <- coef(lm)[["armCommunity arm"]] # Risk Difference
  lm.se <- sqrt(diag( vcovHC(lm, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  rd_ci <- c(coef(lm)[["armCommunity arm"]] - qnorm(0.975)*lm.se, 
               coef(lm)[["armCommunity arm"]] + qnorm(0.975)*lm.se) # RD: 95% CI with robust SE
  rd_p <- 2*pnorm(abs(coef(lm)[["armCommunity arm"]]/lm.se), lower.tail = F)

  # Adjusted for age, gender, smoking (with 3-way interaction effects for all vars)
  adj.lm <- lm(get(v) ~ arm + age_cat + genderR + smoking_status, 
              data = ncd_country_subset )
  adj.rd <- coef(adj.lm)[["armCommunity arm"]] # Risk Difference
  adj.lm.se <- sqrt(diag(vcovHC(adj.lm, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  adj.rd_ci <- c(coef(adj.lm)[["armCommunity arm"]] - qnorm(0.975)*adj.lm.se, 
                 coef(adj.lm)[["armCommunity arm"]] + qnorm(0.975)*adj.lm.se) # RD: 95% CI with robust SE
  adj.rd_p <- 2*pnorm(abs(coef(adj.lm)[["armCommunity arm"]]/adj.lm.se), lower.tail = F)

  # Adjusted for VS, age, gender, smoking (with 3-way interaction effects for all vars)
  ext.lm <- lm(get(v) ~ arm + age_cat + genderR + smoking_status + exit_viral_load_suppressedR, 
              data = ncd_country_subset )
  ext.rd <- coef(ext.lm)[["armCommunity arm"]] # Risk Difference
  ext.lm.se <- sqrt(diag(vcovHC(ext.lm, type = "HC0")))["armCommunity arm"] # Robust SE (unexponentiated)
  ext.rd_ci <- c(coef(ext.lm)[["armCommunity arm"]] - qnorm(0.975)*ext.lm.se, 
                 coef(ext.lm)[["armCommunity arm"]] + qnorm(0.975)*ext.lm.se) # RD: 95% CI with robust SE
  ext.rd_p <- 2*pnorm(abs(coef(ext.lm)[["armCommunity arm"]]/ext.lm.se), lower.tail = F)

  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.numeric(round(rd, round_digits)), 
                paste0("(",
                       as.numeric(round(rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(rd_p, p_digits)),
                as.numeric(round(adj.rd, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.rd_p, p_digits)),
                as.numeric(round(ext.rd, round_digits)), 
                paste0("(",
                       as.numeric(round(ext.rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(ext.rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(ext.rd_p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)
  
  temp_row_plot <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.numeric(rd), 
                as.numeric(rd_ci[1]),
                as.numeric(rd_ci[2]),
                as.numeric(round(rd_p, p_digits)),
                as.numeric(adj.rd), 
                as.numeric(adj.rd_ci[1]),
                as.numeric(adj.rd_ci[2]),
                as.numeric(round(adj.rd_p, p_digits)),
                as.numeric(ext.rd), 
                as.numeric(ext.rd_ci[1]),
                as.numeric(ext.rd_ci[2]),
                as.numeric(round(ext.rd_p, p_digits))
               )
  
  plotDF <- rbind(plotDF, temp_row_plot)
}
  
names(regressionDF) =
  c("Variable",
    "Risk Difference",
    "95% CI",
    "p-value",
    "Adj. Risk Difference",
    "Adj. 95% CI",
    "Adj. p-value",
    "Ext. Risk Difference",
    "Ext. 95% CI",
    "Ext. p-value")

names(plotDF) =
  c("Variable",
    "main.estimate",
    "main.lower",
    "main.upper",
    "main.p",
    "adj.estimate",
    "adj.lower",
    "adj.upper",
    "adj.p",
    "ext.estimate",
    "ext.lower",
    "ext.upper",
    "ext.p")

plotDF <-  plotDF %>% 
    gather(label, value, 2:13) %>% 
    separate(label, into = c("model", "estimate")) %>% 
    mutate(value = as.numeric(value)) %>% 
    spread(key = estimate, value = value) %>% 
    mutate(country = s,
           outcome = "risk_difference")

results_list[[length(results_list) + 1]] <- plotDF
names(results_list)[length(results_list)] <- paste("rd",s, sep = ".")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c(paste0(s, " (n = " , N, ")"), "Baseline Analysis", "Adjusted Analysis", "Extended Analysis \n (including Viral Suppression)"), 
                 top = T, colwidths = c(1, 3, 3, 3)) %>% 
  width(width = .95) %>%
  width(j = 1, width = 1.3) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

flextable_to_rmd(ft)  

}


```

&nbsp;

+ Relative risk is estimated using a quasipoisson model with robust SEs (and log link).
+ Risk difference is estimated using a linear model with robust SEs.
+ Adjusted models include age, smoking and gender.
+ The extended model includes viral suppression and all adjustment variables.

### Page Break

```{r, echo = F, fig.width = 12}
plotDF <- rbind(results_list[["rr.Overall"]],
                results_list[["rd.Overall"]],
                results_list[["rr.South Africa"]],
                results_list[["rd.South Africa"]],
                results_list[["rr.Uganda"]],
                results_list[["rd.Uganda"]])

plotDF <- plotDF %>% 
  select(country, model, outcome, Variable, estimate, lower, upper, p) %>% 
  group_by(outcome) %>% 
  mutate(index = as.numeric(as.factor(Variable)))

# Relative Risk

plot_subset <- plotDF %>% 
  filter(outcome == "relative_risk", model == "ext")

y_breaks <- -sort(unique(plot_subset$index))
y_labels <- unique(plot_subset$Variable)

ggplot(data = plot_subset) + 
  theme_bw() +
  geom_vline(xintercept = 0, linetype="dashed") +
  geom_point(aes(x = estimate, y = -index), size=2.5) +
  geom_segment(aes(y= -index, yend=-index, x = lower, xend = upper), size=.95) +
  xlab("Estimate and 95% Uncertainty Interval") +
  ylab("Variable") +
  scale_y_continuous(labels = y_labels, breaks=y_breaks) +
  facet_wrap(~country) +
  ggtitle("Relative Risk")


# Risk difference

plot_subset <- plotDF %>% 
  filter(outcome == "risk_difference", model == "ext")

y_breaks <- -sort(unique(plot_subset$index))
y_labels <- unique(plot_subset$Variable)

ggplot(data = plot_subset) + 
  theme_bw() +
  geom_vline(xintercept = 0, linetype="dashed") +
  geom_point(aes(x = estimate, y = -index), size=2.5) +
  geom_segment(aes(y= -index, yend=-index, x = lower, xend = upper), size=.95) +
  xlab("Estimate and 95% Uncertainty Interval") +
  ylab("Variable") +
  scale_y_continuous(labels = y_labels, breaks=y_breaks) +
  facet_wrap(~country) +
  ggtitle("Risk Difference")

```
