---
title: "DO ART NCD Tables & Figures"
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    reference_docx: word_styles.docx

---

```{r setup, include = F, echo = F, warning = F, message = F}

rm(list=ls())

# Load packages 

package.list <- c("plyr", "dplyr", "tidyr", "magrittr", "data.table", "ggplot2",
                  "janitor", "tables", "flextable", # table formatting
                  "geepack", "sandwich", # regression analysis 
                  "ggpubr"
                  )

# new.packages <- package.list[!(package.list %in% installed.packages()[,"Package"])]
# if(length(new.packages)) install.packages(new.packages)

invisible(lapply(package.list, library, character.only = TRUE))

# Load data

dir <- "C:/Users/msahu/Documents/Other_Research/DO_ART_NCD/"
in_dir <- paste0(dir, "0_data/3_cleaned_data/")

# Subset to South Africa only!!
# NOTE: we combine the community and hybrid arm (community follow-up), compared to clinic

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" ))
  
  
round_digits = 2
p_digits = 3

# WARNING that chunks build on each other! Can't run individually

```

## Main paper tables (South Africa only)

+ Table 1: Descriptive statistics of cardiovascular risk in the South Africa site of the DO ART study, by trial arm and gender
+ Table 2: Poisson + linear regressions for community follow-up compared with clinic follow-up, and including VS
+ Table 3: Poisson + linear regressions with VS as predictor, stratified by treatment arm; with interaction term for VS

## Distribution figures (South Africa only)

+ Figure 1: CVD variables, comparing VS versus not

### Page Break


## Figure 1: Distribution of clinical CVD measures, by arm [dashed lines are group medians]

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}
# Graph, by arm

df <- ncd_merged_subset %>% 
  mutate(`Trial arm` = armR)

alpha_level = 0.35

lp = "bottom" # legend position, for all distribution figures

# SBP        

cvd_cutoff1 = 120
cvd_cutoff2 = NA
cvd_label = "Systolic BP (mmHg)"

mu <- plyr::ddply(df, "`Trial arm`", summarise, grp.median=median(sbp_mean_exit, na.rm = T))
                
p1 <-  ggplot(data = df, aes(x = sbp_mean_exit, fill = `Trial arm`)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values=c("#1b9e77", "#d95f02")) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=`Trial arm`),
                 linetype="dashed") +
      scale_color_manual(values=c("#1b9e77", "#d95f02")) +
      theme_bw() +
      theme(legend.position = lp)
    
# DBP

cvd_cutoff1 = 80
cvd_cutoff2 = NA
cvd_label = "Diastolic BP (mmHg)"

mu <- plyr::ddply(df, "`Trial arm`", summarise, grp.median=median(dbp_mean_exit, na.rm = T))
                
p2 <-  ggplot(data = df, aes(x = dbp_mean_exit, fill = `Trial arm`)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values=c("#1b9e77", "#d95f02")) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=`Trial arm`),
                 linetype="dashed") +
      scale_color_manual(values=c("#1b9e77", "#d95f02")) +
      theme_bw() +
      theme(legend.position = lp)

# BMI

cvd_cutoff1 = 25
cvd_cutoff2 = 30
cvd_label = "BMI (kg/m^2)"

mu <- plyr::ddply(df, "`Trial arm`", summarise, grp.median=median(bmi, na.rm = T))
                
p3 <-  ggplot(data = df, aes(x = bmi, fill = `Trial arm`)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values=c("#1b9e77", "#d95f02")) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=`Trial arm`),
                 linetype="dashed") +
      scale_color_manual(values=c("#1b9e77", "#d95f02")) +
      theme_bw() +
      theme(legend.position = lp)

# A1c

cvd_cutoff1 = 5.7
cvd_cutoff2 = 6.5
cvd_label = "Hemoglobin A1c (%)"

mu <- plyr::ddply(df, "`Trial arm`", summarise, grp.median=median(hemoglobin_a1c_result, na.rm = T))
                
p4 <-  ggplot(data = df, aes(x = hemoglobin_a1c_result, fill = `Trial arm`)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values=c("#1b9e77", "#d95f02")) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=`Trial arm`),
                 linetype="dashed") +
      scale_color_manual(values=c("#1b9e77", "#d95f02")) +
      theme_bw() +
      theme(legend.position = lp)

# Cholesterol


cvd_cutoff1 = 200
cvd_cutoff2 = 240
cvd_label = "Total cholesterol (mg/dL"

mu <- plyr::ddply(df, "`Trial arm`", summarise, grp.median=median(lipid_result, na.rm = T))
                
p5 <-  ggplot(data = df, aes(x = lipid_result, fill = `Trial arm`)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values=c("#1b9e77", "#d95f02")) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color= `Trial arm`),
                 linetype="dashed") +
      scale_color_manual(values=c("#1b9e77", "#d95f02")) +
      theme_bw() +
      theme(legend.position = lp)

# Arrange!

ggarrange(p1, p3, p4, p5, # skip DBP
          ncol = 2)

```

### Page Break
## Figure 2: Distribution, by viral suppression status at endline [dashed lines are group medians]

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}
df = ncd_merged_subset %>%  filter(exit_viral_load_suppressedR != "Missing")
alpha_level = 0.5

# Excluding missing

vs_colors = c("#00A08A", "#FF0000")
vs_title = "Virally suppressed at exit"

# SBP        

cvd_cutoff1 = 120
cvd_cutoff2 = NA
cvd_label = "Systolic BP (mmHg)"

mu <- plyr::ddply(df, "exit_viral_load_suppressedR", summarise, grp.median=median(sbp_mean_exit, na.rm = T))
                
p1 <-  ggplot(df, aes(x = sbp_mean_exit, fill = exit_viral_load_suppressedR)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values = vs_colors) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=exit_viral_load_suppressedR),
                 linetype="dashed") +
      scale_color_manual(values= vs_colors) +
      guides(fill=guide_legend(title = vs_title)) +
      guides(color=guide_legend(title = vs_title)) +
      theme_bw() +
      theme(legend.position = lp)
    
# DBP

cvd_cutoff1 = 80
cvd_cutoff2 = NA
cvd_label = "Diastolic BP (mmHg)"

mu <- plyr::ddply(df, "exit_viral_load_suppressedR", summarise, grp.median=median(dbp_mean_exit, na.rm = T))
                
p2 <-  ggplot(df, aes(x = dbp_mean_exit, fill = exit_viral_load_suppressedR)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values= vs_colors) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=exit_viral_load_suppressedR),
                 linetype="dashed") +
      scale_color_manual(values= vs_colors) +
      guides(fill=guide_legend(title=vs_title)) +
      guides(color=guide_legend(title=vs_title)) +
      theme_bw() +
      theme(legend.position = lp)

# BMI

cvd_cutoff1 = 25
cvd_cutoff2 = 30
cvd_label = "BMI (kg/m^2)"

mu <- plyr::ddply(df, "exit_viral_load_suppressedR", summarise, grp.median=median(bmi, na.rm = T))
                
p3 <-  ggplot(df, aes(x = bmi, fill = exit_viral_load_suppressedR)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values = vs_colors) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=exit_viral_load_suppressedR),
                 linetype="dashed") +
      scale_color_manual(values = vs_colors) +
      guides(fill=guide_legend(title=vs_title)) +
      guides(color=guide_legend(title=vs_title)) +
      theme_bw() +
      theme(legend.position = lp)

# A1c

cvd_cutoff1 = 5.7
cvd_cutoff2 = 6.5
cvd_label = "Hemoglobin A1c (%)"

mu <- plyr::ddply(df, "exit_viral_load_suppressedR", summarise, grp.median=median(hemoglobin_a1c_result, na.rm = T))
                
p4 <-  ggplot(df, aes(x = hemoglobin_a1c_result, fill = exit_viral_load_suppressedR)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values = vs_colors) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=exit_viral_load_suppressedR),
                 linetype="dashed") +
      scale_color_manual(values = vs_colors) +
      guides(fill=guide_legend(title=vs_title)) +
      guides(color=guide_legend(title=vs_title)) +
      theme_bw() +
      theme(legend.position = lp)

# Cholesterol


cvd_cutoff1 = 200
cvd_cutoff2 = 240
cvd_label = "Total cholesterol (mg/dL)"

mu <- plyr::ddply(df, "exit_viral_load_suppressedR", summarise, grp.median=median(lipid_result, na.rm = T))
                
p5 <-  ggplot(df, aes(x = lipid_result, fill = exit_viral_load_suppressedR)) + 
      geom_density(alpha = alpha_level) +   
      scale_fill_manual(values = vs_colors) +
      xlab(cvd_label) +
      geom_vline(xintercept = c(cvd_cutoff1, cvd_cutoff2), size = .6) +
      geom_vline(data=mu, aes(xintercept=grp.median, color=exit_viral_load_suppressedR),
                 linetype="dashed") +
      scale_color_manual(values = vs_colors) +
      guides(fill=guide_legend(title=vs_title)) +
      guides(color=guide_legend(title=vs_title)) +
      theme_bw() +
      theme(legend.position = lp)

# Arrange!

ggarrange(p1, p3, p4, p5, # skip DBP
          ncol = 2)


```
