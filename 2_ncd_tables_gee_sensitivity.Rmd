---
title: "DO ART NCD Tables & Figures - INCLUDING BASELINE BMI"
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    reference_docx: word_styles.docx

---

```{r setup, include = F, echo = F, warning = F, message = F}

rm(list=ls())

# Load packages 

package.list <- c("plyr", "dplyr", "tidyr", "magrittr", "data.table", "ggplot2",
                  "janitor", "tables", "flextable", # table formatting
                  "geepack", "sandwich", # regression analysis 
                  "ggpubr"
                  )

# new.packages <- package.list[!(package.list %in% installed.packages()[,"Package"])]
# if(length(new.packages)) install.packages(new.packages)

invisible(lapply(package.list, library, character.only = TRUE))

# Load data

dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/DGH+MGH/DO_ART_NCD/"
in_dir <- paste0(dir, "0_data/3_cleaned_data/")

# Subset to South Africa only!!
# NOTE: we combine the community and hybrid arm (community follow-up), compared to clinic

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" )) 
  
  
round_digits = 2
p_digits = 3

# Number plugging: % individuals in a household with multiple participants?
total_n <- ncd_merged_subset %>% nrow()
unique_hh <- length(unique(ncd_merged_subset$hhid))
```

## Sensitivity analysis tables (South Africa only)

+ Table 3: Poisson + linear regressions with VS as predictor
+ Table 4: Poisson + linear regressions with VS as predictor, stratified by treatment arm; with interaction term for VS

&nbsp;

Notes:

+ Baseline models include study site only
+ Adjusted models include: study site, gender, age group, smoking (binary; otherwise we get small group problems), education, **baseline BMI**
&nbsp;



```{r, echo = F, warning = F, message = F}


# A) Demographics
A_vars = c(
  "age_cat",
  "genderR",
  "educationR"
  )
A_var_labels = c(
  "Age",
  "Gender",
  "Education"
  )

# B) Lifestyle and Other Risk

B_vars = c(  
  "smoking_cat",
  "exer_cat",
  "veg_cat",
  "stroke_cat")
B_var_labels = c(
  "Smoking Status  \n [Baseline]",
  "Days of exercise (per week) \n [Exit]",
  "Vegetable intake \n [Exit]",
   "Prior stroke or heart attack  \n [Exit]")


# C) Cardiovascular risk
C_vars = c(
  "bp_cat_exit", 
  "bmi_cat_exit", 
  "a1c_cat_exit", 
  "total_cholesterol_exit",
  "who_cvd_risk_exit")
C_var_labels = c(
  "Blood pressure \n [Exit]",
   "BMI (kg/m^2) \n [Exit]",
   "Hemoglobin A1C (%) \n [Exit]",
   "Total cholesterol (mg/dL) \n [Exit]",
   "10-year CVD risk score \n [Exit]")

```

### PAGE BREAK

## Table 3: Cardiovascular risk among people virally suppressed versus those not virally suppressed at exit, South Africa (N = 589).

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# Subset to South Africa only!!
# NOTE: we combine the community and hybrid arm (community follow-up), compared to clinic

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" ))
  
  
round_digits = 2
p_digits = 3

# DROP NA for GEE to run

vs_subset <- ncd_merged_subset %>% 
  filter(!is.na(exit_viral_load_result)) %>% 
  filter(!is.na(baseline_bmi))

# POISSON REGRESSIONS --------------------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
    "smokingR"
   ),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
    "Current smoker [baseline]"
  ))
  
regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character() 
    )

 
for (v in unique(reg_vars$var_name)) {

  # Adjusted for site only
  m <- geeglm(get(v) ~ site + exit_viral_load_suppressed , 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se, 
                  coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI 
  m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
  
  # Adjusted for site, age, gender, smoking 
  
  if (v != "smokingR") {
  
  adj.m <- geeglm(get(v) ~ site + age_cat + genderR + smokingR + exit_viral_load_suppressed +baseline_bmi + educationR, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  if (v == "smokingR") {
  
  adj.m <- geeglm(get(v) ~ site + age_cat + genderR + exit_viral_load_suppressed +baseline_bmi + educationR, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                format(round(m.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(m.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(m.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(m.p, p_digits), nsmall = p_digits),
                format(round(adj.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.p, p_digits), nsmall = p_digits))
  
  regressionDF <- rbind(regressionDF, temp_row)
  
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -------------------------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic blood pressure (mmHg)",
    "Diastolic blood pressure (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() 
)
 
 
for (v in unique(lin_reg_vars$var_name)) {
  
   # Adjusted for site only
  lm <- geeglm(get(v) ~ site + exit_viral_load_suppressed, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se, 
                coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # 95% CI
  rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE",4]

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~  site + age_cat + genderR + smoking_status + exit_viral_load_suppressed + baseline_bmi + educationR, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(rd_p, p_digits), nsmall = p_digits),
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF <- rbind(regressionDF, temp_row)

}
  
names(regressionDF) =
  c("Variable",
    "Mean Difference",
    "95% CI",
    "p-value",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft
```


### PAGE BREAK

## Table 4: Cardiovascular risk for persons virally suppressed versus not suppressed at exit, South Africa (N =589). 
&nbsp;

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

vs_subset <- ncd_merged_subset %>% 
  filter(!is.na(exit_viral_load_result)) %>% 
  filter(!is.na(baseline_bmi))

# POISSON REGRESSIONS -------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
  #  "total_cholesterol_hi_exit",
    "smokingR"),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
 #   "Elevated lipids (total cholesterol >= 200)",
    "Current smoker [baseline]"))
  

# COMMUNITY VS. CLINIC FOLLOW-UP

# --- clinic

vs_arm_subset <- vs_subset %>% filter(armR == "Clinic follow-up")

N_clinic = vs_arm_subset %>% nrow()

regressionDF_clinic <- data.frame(
        variable = character(),
        clinic_adj.rr =  numeric(),
        clinic_adj.rr_ci = character(), 
        clinic_adj.rr_p = character()
    )
 
for (v in unique(reg_vars$var_name)) {


  # Adjusted for site, age, gender, smoking 
  
  if (v != "smokingR") {
  
  adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR + baseline_bmi + educationR, 
              family = poisson, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  }
  
  if (v == "smokingR") {
  
  adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + baseline_bmi +educationR, 
              family = poisson, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  }
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI 
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                format(round(adj.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.p, p_digits), nsmall = round_digits))
  
  regressionDF_clinic <- rbind(regressionDF_clinic, temp_row) %>% 
    rename(variable = 1)
  
}
  
# --- community

vs_arm_subset <- vs_subset %>% filter(armR == "Community follow-up")

N_community = vs_arm_subset %>% nrow()

regressionDF_community <- data.frame(
        variable = character(),
        community_adj.rr =  numeric(),
        community_adj.rr_ci = character(), 
        community_adj.rr_p = character()
    )
 
for (v in unique(reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  if (v != "smokingR") {
  
  adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR + baseline_bmi + educationR, 
              family = poisson, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  }
  
  if (v == "smokingR") {
  
  adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + baseline_bmi +educationR, 
              family = poisson, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  }
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI 
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                format(round(adj.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.p, p_digits), nsmall = p_digits))
  
  regressionDF_community <- rbind(regressionDF_community, temp_row) %>% 
    rename(variable = 1)
  
}

# Interaction term: Adjusted for site, age, gender, smoking 

intDF <- data.frame(
        variable = character(),
        int.p = character()
    )
 
for (v in unique(reg_vars$var_name)) {

  
  if (v != "smokingR") {
  
  int.m <- geeglm(get(v) ~ site + age_cat + genderR + smokingR + exit_viral_load_suppressed*armR + baseline_bmi +educationR, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  int.p <- summary(int.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
  }
  
  if (v == "smokingR") {
  
  int.m <- geeglm(get(v) ~ site + age_cat + genderR + exit_viral_load_suppressed*armR + baseline_bmi, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 

  int.p <- summary(int.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
  }
   temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.character(round(int.p, p_digits)))
  
  intDF <- rbind(intDF, temp_row) %>% 
    rename(variable = 1)
  
  }


regressionDF <- regressionDF_clinic %>% 
  left_join(regressionDF_community, by = "variable") %>% 
  left_join(intDF, by = "variable")
  
names(regressionDF) =
  c("Variable",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value",
    "Adj. Relative Risk ",
    "Adj. 95% CI ",
    "Adj. p-value ",
    "Adj.  p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", paste0("Clinic follow-up, Adjusted \n (N = ", N_clinic, ")"),
                            paste0("Community follow-up, Adjusted \n (N = ", N_community, ")"), 
                             paste0("Interaction \n (N = ", N_community + N_clinic, ")")), 
                 top = T, colwidths = c(1, 3, 3, 1)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 1.75) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -----------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic BP (mmHg)",
    "Diastolic BP (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  


# COMMUNITY VS. CLINIC FOLLOW-UP

# --- clinic

vs_arm_subset <- vs_subset %>% filter(armR == "Clinic follow-up")

N_clinic = vs_arm_subset %>% nrow()

regressionDF_clinic <- data.frame(
        variable = character(),
        clinic_adj.rr =  numeric(),
        clinic_adj.rr_ci = character(), 
        clinic_adj.rr_p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR + baseline_bmi +educationR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
              family = gaussian, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
 

  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF_clinic <- rbind(regressionDF_clinic, temp_row) %>% 
    rename(variable = 1)
  
}

# --- ccommunity

vs_arm_subset <- vs_subset %>% filter(armR == "Community follow-up")

N_community = vs_arm_subset %>% nrow()

regressionDF_community <- data.frame(
        variable = character(),
        community_adj.rr =  numeric(),
        community_adj.rr_ci = character(), 
        community_adj.rr_p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_cat + genderR + smokingR + baseline_bmi + educationR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
              family = gaussian, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
 

  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF_community <- rbind(regressionDF_community, temp_row) %>% 
    rename(variable = 1)
  
}  



intDF <- data.frame(
        variable = character(),
        int.p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {
  
  int.m <- geeglm(get(v) ~  site + age_cat + genderR + smokingR + exit_viral_load_suppressed*armR + baseline_bmi + educationR, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  int.p <- summary(int.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
 
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.character(round(int.p, p_digits)))
  
  intDF <- rbind(intDF, temp_row) %>% 
    rename(variable = 1)
  
  }


regressionDF <- regressionDF_clinic %>% 
  left_join(regressionDF_community, by = "variable") %>% 
  left_join(intDF, by = "variable")
  
names(regressionDF) =
  c("Variable",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value",
    "Adj. Mean Difference ",
    "Adj. 95% CI ",
    "Adj. p-value ",
    "Adj.  p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", paste0("Clinic follow-up, Adjusted \n (N = ", N_clinic, ")"),
                            paste0("Community follow-up, Adjusted \n (N = ", N_community, ")"), 
                             paste0("Interaction \n (N = ", N_community + N_clinic, ")")), 
                 top = T, colwidths = c(1, 3, 3, 1)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 1.75) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

```


