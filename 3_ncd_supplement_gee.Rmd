---
title: "DO ART NCD Supplement"
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    reference_docx: word_styles.docx

---

```{r setup, include = F, echo = F, warning = F, message = F}

rm(list=ls())

# Load packages

package.list <- c("plyr", "dplyr", "tidyr", "magrittr", "data.table", "ggplot2",
                  "janitor", "tables", "flextable", # table formatting
                  "geepack", "sandwich", # regression analysis 
                  "ggpubr"
                  )

invisible(lapply(package.list, library, character.only = TRUE))

# Load data

dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/DGH+MGH/DO_ART_NCD/"
in_dir <- paste0(dir, "0_data/3_cleaned_data/")
source(paste0(dir, "2_code/plot_functions.R"))

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" ))



ncd_noHybrid <- ncd_merged_subset %>% filter(arm!= "Hybrid arm")
round_digits = 2
p_digits = 3

```


# Appendix tables 

## S1: Variables Description

+ S1 Codebook (included with main paper)

## S2: Additional Descriptive Statistics

+ S2, Table 1: Change in cardiovascular risk from baseline to endline, by trial arm and gender (AHRI site only, N = 350)
+ S2, Table 2: Descriptive statistics of cardiovascular risk in the DO ART study, by site and including Uganda (N = 1315)
+ S2, Table 3: Descriptive statistics of cardiovascular risk in the DO ART study for South Africa, by viral suppression (N = 1010)
+ S2, EXTRA table: Descriptive statistics of cardiovascular risk in the DO ART Study for South Africa, by ART initiation 

## S3: Additional Analysis

+ S3, Table 3: Interaction term coefficients 
+ S3, Table 4: Table 3 by gender (adjusted only)
+ S3, Table 5: Table 3 restricted to people who initiated ART 
+ S3, Table 6: Table 4 restricted to people who initiated ART 
+ S3, Table 7: Tables for the difference in difference in CVD risk (not coded correctly??? Midlands v Northern is potentially interesting)
+ S3, EXTRA table: Table 3 by site (adjusted only)

## S4: Missing Data Analysis

## S5: Figures

+ S5 Figure 1: CVD variables, comparing community follow-up with clinic follow-up
+ S5 Figure 2: Distribution of CVD risk by gender
+ S5 Figure 3: Distribution of cardiovascular risk, by viral suppression status at exit 
+ S5 Figure 4: CVD variables, comparing VS versus not - CLINIC FOLLOW-UP GROUP
+ S5 Figure 5: CVD variables, comparing VS versus not - COMMUNITY FOLLOW-UP GROUP
+ S5 Figure 6: CVD variables, by VS and age
+ S5 Figure 7: Distribution of CVD variables by education

### Page Break

## Appendix Table 1: Change in cardiovascular risk from baseline to endline, by trial arm and gender (AHRI site only, N = 350)

&nbsp;


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
  
# Set up -------------------------------------------------------------

headings <- data.frame(
  section = c("A", "B", "C"),
  title = c( "", 
             "ii) Lifestyle and other risk",
              "iii) Cardiovascular Risk")
)

# A) Demographics
A_vars = c(
  "age_catR",
  "genderR"
  )
A_var_labels = c(
  "Age",
  "Gender"
  )

# B) Lifestyle and Other Risk

B_vars = c(  
  "smoking_catR",
  "exer_catR",
  "veg_catR",
  "stroke_catR")
B_var_labels = c(
  "Smoking Status  \n [Baseline]",
  "Days of exercise (per week) \n [Endline]",
  "Vegetable intake \n [Endline]",
   "Prior stroke or heart attack  \n [Endline]")


# C) Cardiovascular risk
C_vars = c(
  "bp_cat_exit", 
  "bmi_cat_exit", 
  "a1c_cat_exit", 
  "total_cholesterol_exit",
  "who_cvd_risk_exit")
C_var_labels = c(
  "Blood pressure \n [Endline]",
   "BMI (kg/m^2) \n [Endline]",
   "Hemoglobin A1C (%) \n [Endline]",
   "Total cholesterol (mg/dL) \n [Endline]",
   "10-year CVD risk score \n [Endline]")

# D) Change in CVD risk
D_vars = c(  
  "bmi_diff",
  "sbp_diff")
D_var_labels = c(
  "Change in BMI, baseline to endline  \n [AHRI only]",
  "Change in Systolic Blood pressure, baseline to endline  \n [AHRI only]" )


table_vars <- data.frame(
  
  var_name = c(D_vars),

  var_label = c(D_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(D_vars) ~ "D"))
  
  
# Descriptive Proportion Table ----------------------------------------------------

col_headings_mean <- c(
  "Change in CVD risk",
  "Clinic Follow-Up Arm \n Mean (SE)", 
  "Community Follow-Up Arm \n Mean (SE)",
  "Women \n Mean (SE)", 
  "Men \n Mean (SE)",
  "Virally Suppressed at Exit \n Mean (SE)", 
  "Not Virally Suppressed at Exit \n Mean (SE)",
  "Total \n Mean (SE)"
  )


  table_subset <- table_vars[table_vars$section=="D", ]
  
  tableDF <- data.frame(
        variable = character(),
        clinic_arm = character(),
        community_arm = character(),
        hybrid_arm = character(),
        vs_true = character(),
        vs_false = character(),
        Women = character(),
        Men = character(),
        Total = character()
    )
  
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset %>% filter(site == "AHRI") # subset to AHRI for this section
    
    m <- geeglm( get(v) ~ 1, 
            family = gaussian, data = data,
            id = hhid, corstr = "independence") 
    
    mean =  round( coef(m)[["(Intercept)"]], round_digits)
    se = round( summary(m)$coef["(Intercept)", 2], round_digits)
    
    result_total = paste0(mean, " (", se, ")")
    
    for (t in unique(data$armR)) {
        
      m <- geeglm( get(v) ~ 1, 
            family = gaussian, data = data %>% filter(armR == t),
            id = hhid, corstr = "independence") 
    
      mean = round( coef(m)[["(Intercept)"]], round_digits)
      se = round( summary(m)$coef["(Intercept)", 2], round_digits)
      
      assign(paste0("result_",t), paste0(mean, " (", se, ")"))
      
    }
    
    for (s in c(T,F)) {
        
      m <- geeglm( get(v) ~ 1, 
            family = gaussian, data = data %>% filter(exit_viral_load_suppressed == s),
            id = hhid, corstr = "independence") 
    
      mean = round( coef(m)[["(Intercept)"]], round_digits)
      se = round( summary(m)$coef["(Intercept)", 2], round_digits)
      
      assign(paste0("result_",s), paste0(mean, " (", se, ")"))
      
    }
    
    
     for (g in unique(data$genderR)) {
        
      m <- geeglm( get(v) ~ 1, 
            family = gaussian, data = data %>%  filter(genderR == g),
            id = hhid, corstr = "independence") 
    
      mean =  round(coef(m)[["(Intercept)"]], round_digits)
      se = round(summary(m)$coef["(Intercept)", 2], round_digits)
      
      assign(paste0("result_",g), paste0(mean, " (", se, ")"))
     }
    
    temp_row = c(table_vars[table_vars$var_name == v, "var_label"],
                 `result_Clinic follow-up` ,
                 `result_Community follow-up`,
                 result_Women,
                 result_Men,
                 result_TRUE,
                 result_FALSE,
                 result_total)
    
    tableDF <- rbind(tableDF, temp_row)
}
  
  # Flextable
  
names(tableDF) <- c("variable", 
                   "clinic_arm", "community_arm",
                    "Women", "Men", 
                   "vs_true", "vs_false",
                    "Total")

ft <- flextable(tableDF) %>%
   
  delete_part(part = "header") %>%
  add_header_row(values = c(col_headings_mean))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  width(width = 1) %>% 
    width(j = 1, width = 2) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 3, 5, 7), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

```

### Page break

## Appendix Table 2: Descriptive statistics of cardiovascular risk in the DO ART study, by site (N = 1315)

&nbsp;


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
# Set up --------------------------------------------------------------------------

headings <- data.frame(
  section = c("A", "B", "C"),
  title = c( "", 
             "ii) Lifestyle and other risk",
              "iii) Cardiovascular Risk")
)

# A) Demographics
A_vars = c(
  "age_catR","genderR", "educationR"
  )
A_var_labels = c(
  "Age", "Gender", "Education"
  )

# B) Lifestyle and Other Risk (same as above)

# C) Cardiovascular risk (same as above)

table_vars <- data.frame(
  
  var_name = c(A_vars, B_vars, C_vars),

  var_label = c(A_var_labels, B_var_labels, C_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(A_vars) ~ "A",
      var_name %in% c(B_vars) ~ "B",
      var_name %in% c(C_vars) ~ "C")
    )
  

# Descriptive Proportion Table ----------------------------------------------------

col_headings_freq <- c(
  "Category",
  "SW Uganda \n n (%)",
  "Midlands KZN SA \n n (%)", 
  "Northern KZN SA \n n (%)",
  "Total \n n (%)"
  )


for (i in unique(headings$section)) {
  
  table_subset <- table_vars[table_vars$section==i, ]
  
  tableDF <- data.frame(
        variable = character(),
        category = character(),
        sw_uganda = character(),
        midlands_kzn = character(),
        northern_kzn = character(),
        Total = character()
    )
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset 
    
    temp <- data %>% 
      
      # Format table using Janitor package 
      tabyl(!!sym(v), site) %>% 
      adorn_totals(where = "col") %>% 
      adorn_percentages(denominator = "col") %>% 
      adorn_pct_formatting(digits = 0, affix_sign = TRUE) %>% 
      adorn_ns(position = "front") %>%
      as.data.frame() %>% 
      
      # Clean up headers
      rename(category = 1,
             sw_uganda = "ICOBI",
             midlands_kzn = "HSRC",
             northern_kzn = "AHRI") %>% 
      mutate(variable = table_vars[table_vars$var_name == v, "var_label"] ) %>% 
      select(variable, everything())
    
  tableDF <- rbind(tableDF, temp)
  
  }
  
  # Flextable

ft <- flextable(tableDF) %>%
  
  delete_part(part = "header") %>%
  add_header_row(values = c(headings[headings$section == i, "title"], col_headings_freq))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  merge_v(j = "variable") %>%
  width(width = 1.55) %>%
  theme_vanilla() %>% 
  vline(j = c(2, 5), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

rm(temp)  
}
```

### Page break

&nbsp;


## Appendix Table 3: Descriptive statistics of cardiovascular risk in the DO ART study for South Africa, by viral suppression (N = 1010)

&nbsp;


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
# Set up --------------------------------------------------------------------------

headings <- data.frame(
  section = c("A", "B", "C"),
  title = c( "", 
             "ii) Lifestyle and other risk",
              "iii) Cardiovascular Risk")
)

# A) Demographics
A_vars = c(
  "age_catR","genderR", "educationR"
  )
A_var_labels = c(
  "Age", "Gender", "Education"
  )

# B) Lifestyle and Other Risk (same as above)

# C) Cardiovascular risk (same as above)

table_vars <- data.frame(
  
  var_name = c(A_vars, B_vars, C_vars),

  var_label = c(A_var_labels, B_var_labels, C_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(A_vars) ~ "A",
      var_name %in% c(B_vars) ~ "B",
      var_name %in% c(C_vars) ~ "C")
    )
  

# Descriptive Proportion Table ----------------------------------------------------

col_headings_freq <- c(
  "Category",
  "Virally suppressed \n n (%)",
  "Not virally suppressed \n n (%)", 
  "VS unknown \n (%)",
  "Total \n n (%)"
  )


for (i in unique(headings$section)) {
  
  table_subset <- table_vars[table_vars$section==i, ]
  
  tableDF <- data.frame(
        variable = character(),
        category = character(),
        vs = character(),
        not_vs = character(),
        vs_unknown = character(),
        Total = character()
    )
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset %>% filter(country == "South Africa")
    
    temp <- data %>% 
      
      # Format table using Janitor package 
      tabyl(!!sym(v), exit_viral_load_suppressedR) %>% 
      adorn_totals(where = "col") %>% 
      adorn_percentages(denominator = "col") %>% 
      adorn_pct_formatting(digits = 0, affix_sign = TRUE) %>% 
      adorn_ns(position = "front") %>%
      as.data.frame() %>% 
      
      # Clean up headers
      rename(category = 1,
             vs = "Yes",
             not_vs = "No",
             vs_unknown = "Missing") %>% 
      mutate(variable = table_vars[table_vars$var_name == v, "var_label"] ) %>% 
      select(variable, everything())
    
  tableDF <- rbind(tableDF, temp)
  
  }
  
  # Flextable

ft <- flextable(tableDF) %>%
  
  delete_part(part = "header") %>%
  add_header_row(values = c(headings[headings$section == i, "title"], col_headings_freq))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  merge_v(j = "variable") %>%
  width(width = 1.55) %>%
  theme_vanilla() %>% 
  vline(j = c(2, 5), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

rm(temp)  
}
```



### Page break


## Appendix Table 4: Descriptive statistics of cardiovascular risk in the DO ART study for South Africa, by ART initiation

&nbsp;


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
# Set up --------------------------------------------------------------------------

headings <- data.frame(
  section = c("A", "B", "C"),
  title = c( "", 
             "ii) Lifestyle and other risk",
              "iii) Cardiovascular Risk")
)

# A) Demographics
A_vars = c(
  "age_catR","genderR", "educationR"
  )
A_var_labels = c(
  "Age", "Gender", "Education"
  )

# B) Lifestyle and Other Risk (same as above)

# C) Cardiovascular risk (same as above)

table_vars <- data.frame(
  
  var_name = c(A_vars, B_vars, C_vars),

  var_label = c(A_var_labels, B_var_labels, C_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(A_vars) ~ "A",
      var_name %in% c(B_vars) ~ "B",
      var_name %in% c(C_vars) ~ "C")
    )
  

# Descriptive Proportion Table ----------------------------------------------------

col_headings_freq <- c(
  "Category",
  "Initiated ART \n n (%)",
  "Did not initiate ART \n n (%)", 
  "Total \n n (%)"
  )


for (i in unique(headings$section)) {
  
  table_subset <- table_vars[table_vars$section==i, ]
  
  tableDF <- data.frame(
        variable = character(),
        category = character(),
        init_art = character(),
        not_init_art = character(),
        Total = character()
    )
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset %>% filter(country == "South Africa")  
    
    temp <- data %>% 
      
      # Format table using Janitor package 
      tabyl(!!sym(v), initiated_art) %>% 
      adorn_totals(where = "col") %>% 
      adorn_percentages(denominator = "col") %>% 
      adorn_pct_formatting(digits = 0, affix_sign = TRUE) %>% 
      adorn_ns(position = "front") %>%
      as.data.frame() %>% 
      
      # Clean up headers
     rename(category = 1,
          init_art = "TRUE",
            not_init_art = "FALSE"
     ) %>% 
      mutate(variable = table_vars[table_vars$var_name == v, "var_label"] ) %>% 
      select(variable, everything())
    
  tableDF <- rbind(tableDF, temp)
  
  }
  
  # Flextable

ft <- flextable(tableDF) %>%
  
  delete_part(part = "header") %>%
  add_header_row(values = c(headings[headings$section == i, "title"], col_headings_freq))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  merge_v(j = "variable") %>%
  width(width = 1.55) %>%
  theme_vanilla() %>% 
  vline(j = c(2, 5), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

rm(temp)  
}
```

### Page break

## Appendix S3, Table 3: Coefficients for interaction term for cardiovascular risk for persons virally suppressed versus not suppressed at endline in South Africa (N = 983).

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# DROP NA for GEE to run

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" )) 

vs_subset <- ncd_merged_subset %>% 
  filter(!is.na(exit_viral_load_result))

# POISSON REGRESSIONS --------------------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
   # "total_cholesterol_hi_exit",
    "smokingR"
   ),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
   # "Elevated lipids (total cholesterol >= 200)",
    "Current smoker [baseline]"
  ))
  
regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character() 
    )
 
for (v in unique(reg_vars$var_name)) {

  # Adjusted for site only
  m <- geeglm(get(v) ~ site + exit_viral_load_suppressed*armR, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]]) # Relative Risk
  m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",2] # SE
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] - qnorm(0.975)*m.se, 
                  coef(m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] + qnorm(0.975)*m.se)) # RR: 95% CI 
  m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
  # Adjusted for site, age, gender, smoking 
  
  if (v != "smokingR") {
  
  adj.m <- geeglm(get(v) ~ site + age_catR + genderR + smokingR + educationR + exit_viral_load_suppressed*armR, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
  }
  
  if (v == "smokingR") {
  
  adj.m <- geeglm(get(v) ~ site + age_catR + genderR + educationR + exit_viral_load_suppressed*armR, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
  }
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.numeric(round(m.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(m.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(m.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(m.p, p_digits)),
                as.numeric(round(adj.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)
  
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -------------------------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic blood pressure (mmHg)",
    "Diastolic blood pressure (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() 
    )
 
for (v in unique(lin_reg_vars$var_name)) {
  
   # Adjusted for site only
  lm <- geeglm(get(v) ~ site + exit_viral_load_suppressed*armR, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  rd <- coef(lm)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] # Mean Difference
  lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",2] # SE
  rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] - qnorm(0.975)*lm.se, 
                coef(lm)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] + qnorm(0.975)*lm.se) # 95% CI
  rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~  site + age_catR + genderR + smokingR + educationR + exit_viral_load_suppressed*armR, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE:armRCommunity follow-up"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.numeric(round(rd, round_digits)), 
                paste0("(",
                       as.numeric(round(rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(rd_p, p_digits)),
                as.numeric(round(adj.rd, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.rd_p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)
  
}
  
names(regressionDF) =
  c("Variable",
    "Mean Difference",
    "95% CI",
    "p-value",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft
```

** Note, we drop 27 participants without endline viral load available.

** This is the coefficient for VS * arm


## Appendix S3, Table 4: Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline, by gender

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# Subset to South Africa only and clinic arm only!

ncd_merged_women <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" )) %>% 
  filter(genderR == "Women") %>% 
 filter(!is.na(exit_viral_load_result)) # DROP NA for GEE to run

ncd_merged_men <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" )) %>% 
  filter(genderR == "Men") %>% 
filter(!is.na(exit_viral_load_result)) # DROP NA for GEE to run

  
round_digits = 2
p_digits = 3

# POISSON REGRESSIONS --------------------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
    "smokingR"
   ),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
    "Current smoker [baseline]"
  ))
  
regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character() 
    )

 
for (v in unique(reg_vars$var_name)) {
  
  if (v != "smokingR") {
    
  # Women
  m <- geeglm(get(v) ~ site + age_catR + smokingR + educationR + exit_viral_load_suppressed, 
              family = poisson, data = ncd_merged_women,
              id = hhid, corstr = "independence") 
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se, 
                  coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI 
  m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
  
  # Men 
  adj.m <- geeglm(get(v) ~ site + age_catR + smokingR + educationR + exit_viral_load_suppressed, 
              family = poisson, data = ncd_merged_men,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  if (v == "smokingR") {
  
  # Women
  m <- geeglm(get(v) ~ site + age_catR + educationR + exit_viral_load_suppressed, 
              family = poisson, data = ncd_merged_women,
              id = hhid, corstr = "independence") 
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se, 
                  coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI 
  m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
  
  # Men
  adj.m <- geeglm(get(v) ~ site + age_catR + educationR + exit_viral_load_suppressed, 
              family = poisson, data = ncd_merged_men,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.numeric(round(m.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(m.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(m.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(m.p, p_digits)),
                as.numeric(round(adj.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)
  
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    " Relative Risk",
    " 95% CI",
    " p-value")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Women (n = 505)", "Men (n = 505)"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -------------------------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic blood pressure (mmHg)",
    "Diastolic blood pressure (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() 
)
 
 
for (v in unique(lin_reg_vars$var_name)) {
  
   # Midlands
  lm <- geeglm(get(v) ~ site + age_catR + smokingR + educationR + exit_viral_load_suppressed, 
              family = gaussian, data = ncd_merged_women,
              id = hhid, corstr = "independence") 
  rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se, 
                coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # 95% CI
  rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE",4]

  # Northern
  adj.lm <- geeglm(get(v) ~  site + age_catR + smokingR + educationR + exit_viral_load_suppressed, 
              family = gaussian, data = ncd_merged_men,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.numeric(round(rd, round_digits)), 
                paste0("(",
                       as.numeric(round(rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(rd_p, p_digits)),
                as.numeric(round(adj.rd, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.rd_p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)

}
  
names(regressionDF) =
  c("Variable",
    "Mean Difference",
    "95% CI",
    "p-value",
    " Mean Difference",
    " 95% CI",
    " p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Women (n = 505)", "Men (n = 505)"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft
```


### Page Break

## Appendix S3, Table 5: Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline CONTROLLING FOR CD4+ COUNT, in South Africa (N = 983).

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# Subset to South Africa only!!
# NOTE: we combine the community and hybrid arm (community follow-up), compared to clinic

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" ))
  
  
round_digits = 2
p_digits = 3

# DROP NA for GEE to run

vs_subset <- ncd_merged_subset %>% 
  filter(!is.na(exit_viral_load_result))

# POISSON REGRESSIONS --------------------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
    "smokingR"
   ),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
    "Current smoker [baseline]"
  ))
  
regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character() 
    )

 
for (v in unique(reg_vars$var_name)) {

  # Adjusted for site only
  m <- geeglm(get(v) ~ site + exit_viral_load_suppressed, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se, 
                  coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI 
  m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
  
  # Adjusted for site, age, gender, smoking 
  
  if (v != "smokingR") {
  
  adj.m <- geeglm(get(v) ~ site + age_catR + genderR + smokingR + exit_viral_load_suppressed + educationR + baseline_cd4, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  if (v == "smokingR") {
  
  adj.m <- geeglm(get(v) ~ site + age_catR + genderR + exit_viral_load_suppressed + educationR + baseline_cd4, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                format(round(m.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(m.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(m.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(m.p, p_digits), nsmall = p_digits),
                format(round(adj.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.p, p_digits), nsmall = p_digits))
  
  regressionDF <- rbind(regressionDF, temp_row)
  
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -------------------------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic blood pressure (mmHg)",
    "Diastolic blood pressure (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() 
)
 
 
for (v in unique(lin_reg_vars$var_name)) {
  
   # Adjusted for site only
  lm <- geeglm(get(v) ~ site + exit_viral_load_suppressed, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se, 
                coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # 95% CI
  rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE",4]

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~  site + age_catR + genderR + smoking_status + exit_viral_load_suppressed + educationR + baseline_cd4, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(rd_p, p_digits), nsmall = p_digits),
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF <- rbind(regressionDF, temp_row)

}
  
names(regressionDF) =
  c("Variable",
    "Mean Difference",
    "95% CI",
    "p-value",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft
```


### Page Break

## Appendix S3, Table 6: Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline RESTRICTED TO PEOPLE WHO INITIATIED ART, in South Africa (N = 659).

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# Subset to South Africa only!!
# NOTE: we combine the community and hybrid arm (community follow-up), compared to clinic

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" )) 
  
  
round_digits = 2
p_digits = 3

# DROP NA for GEE to run AND RESTRICT TO ART INTITIATORS

vs_subset <- ncd_merged_subset %>% 
  filter(!is.na(exit_viral_load_result)) %>% 
  filter(initiated_art == T)

# POISSON REGRESSIONS --------------------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
    "smokingR"
   ),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
    "Current smoker [baseline]"
  ))
  
regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character() 
    )

 
for (v in unique(reg_vars$var_name)) {

  # Adjusted for site only
  m <- geeglm(get(v) ~ site + exit_viral_load_suppressed, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se, 
                  coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI 
  m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
  
  # Adjusted for site, age, gender, smoking 
  
  if (v != "smokingR") {
  
  adj.m <- geeglm(get(v) ~ site + age_catR + genderR + smokingR + exit_viral_load_suppressed + educationR + baseline_cd4, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  if (v == "smokingR") {
  
  adj.m <- geeglm(get(v) ~ site + age_catR + genderR + exit_viral_load_suppressed + educationR + baseline_cd4, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                format(round(m.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(m.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(m.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(m.p, p_digits), nsmall = p_digits),
                format(round(adj.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.p, p_digits), nsmall = p_digits))
  
  regressionDF <- rbind(regressionDF, temp_row)
  
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -------------------------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic blood pressure (mmHg)",
    "Diastolic blood pressure (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() 
)
 
 
for (v in unique(lin_reg_vars$var_name)) {
  
   # Adjusted for site only
  lm <- geeglm(get(v) ~ site + exit_viral_load_suppressed, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se, 
                coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # 95% CI
  rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE",4]

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~  site + age_catR + genderR + smoking_status + exit_viral_load_suppressed + educationR + baseline_cd4, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(rd_p, p_digits), nsmall = p_digits),
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF <- rbind(regressionDF, temp_row)

}
  
names(regressionDF) =
  c("Variable",
    "Mean Difference",
    "95% CI",
    "p-value",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft
```

### Page Break

## Appendix S3, Table 7: Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline RESTICTED TO PEOPLE WHO INITIATIED ART, in South Africa (N = 659).


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

vs_subset <- ncd_merged_subset %>% 
    filter(initiated_art == T) %>% 
  filter(!is.na(exit_viral_load_result))


# POISSON REGRESSIONS -------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
  #  "total_cholesterol_hi_exit",
    "smokingR"),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
 #   "Elevated lipids (total cholesterol >= 200)",
    "Current smoker [baseline]"))
  

# COMMUNITY VS. CLINIC FOLLOW-UP

# --- clinic

vs_arm_subset <- vs_subset %>% filter(armR == "Clinic follow-up")

N_clinic = vs_arm_subset %>% nrow()

regressionDF_clinic <- data.frame(
        variable = character(),
        clinic_adj.rr =  numeric(),
        clinic_adj.rr_ci = character(), 
        clinic_adj.rr_p = character()
    )
 
for (v in unique(reg_vars$var_name)) {


  # Adjusted for site, age, gender, smoking 
  
  if (v != "smokingR") {
  
  adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_catR + genderR + smokingR + educationR, 
              family = poisson, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  }
  
  if (v == "smokingR") {
  
  adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_catR + genderR + educationR, 
              family = poisson, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  }
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI 
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                format(round(adj.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.p, p_digits), nsmall = round_digits))
  
  regressionDF_clinic <- rbind(regressionDF_clinic, temp_row) %>% 
    rename(variable = 1)
  
}
  
# --- community

vs_arm_subset <- vs_subset %>% filter(armR == "Community follow-up")

N_community = vs_arm_subset %>% nrow()

regressionDF_community <- data.frame(
        variable = character(),
        community_adj.rr =  numeric(),
        community_adj.rr_ci = character(), 
        community_adj.rr_p = character()
    )
 
for (v in unique(reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  if (v != "smokingR") {
  
  adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_catR + genderR + smokingR + educationR, 
              family = poisson, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  }
  
  if (v == "smokingR") {
  
  adj.m <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_catR + genderR + educationR, 
              family = poisson, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  }
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI 
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                format(round(adj.rr, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rr_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.p, p_digits), nsmall = p_digits))
  
  regressionDF_community <- rbind(regressionDF_community, temp_row) %>% 
    rename(variable = 1)
  
}

# Interaction term: Adjusted for site, age, gender, smoking 

intDF <- data.frame(
        variable = character(),
        int.p = character()
    )
 
for (v in unique(reg_vars$var_name)) {

  
  if (v != "smokingR") {
  
  int.m <- geeglm(get(v) ~ site + age_catR + genderR + smokingR + exit_viral_load_suppressed*armR + educationR, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 
  int.p <- summary(int.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
  }
  
  if (v == "smokingR") {
  
  int.m <- geeglm(get(v) ~ site + age_catR + genderR + exit_viral_load_suppressed*armR + educationR, 
              family = poisson, data = vs_subset,
              id = hhid, corstr = "independence") 

  int.p <- summary(int.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
  }
   temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.character(round(int.p, p_digits)))
  
  intDF <- rbind(intDF, temp_row) %>% 
    rename(variable = 1)
  
  }


regressionDF <- regressionDF_clinic %>% 
  left_join(regressionDF_community, by = "variable") %>% 
  left_join(intDF, by = "variable")
  
names(regressionDF) =
  c("Variable",
    "Adj. Relative Risk",
    "Adj. 95% CI",
    "Adj. p-value",
    "Adj. Relative Risk ",
    "Adj. 95% CI ",
    "Adj. p-value ",
    "Adj.  p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", paste0("Clinic follow-up, Adjusted \n (N = ", N_clinic, ")"),
                            paste0("Community follow-up, Adjusted \n (N = ", N_community, ")"), 
                             paste0("Interaction \n (N = ", N_community + N_clinic, ")")), 
                 top = T, colwidths = c(1, 3, 3, 1)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 1.75) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -----------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic BP (mmHg)",
    "Diastolic BP (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  


# COMMUNITY VS. CLINIC FOLLOW-UP

# --- clinic

vs_arm_subset <- vs_subset %>% filter(armR == "Clinic follow-up")

N_clinic = vs_arm_subset %>% nrow()

regressionDF_clinic <- data.frame(
        variable = character(),
        clinic_adj.rr =  numeric(),
        clinic_adj.rr_ci = character(), 
        clinic_adj.rr_p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_catR + genderR + smokingR + educationR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
              family = gaussian, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
 

  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF_clinic <- rbind(regressionDF_clinic, temp_row) %>% 
    rename(variable = 1)
  
}

# --- ccommunity

vs_arm_subset <- vs_subset %>% filter(armR == "Community follow-up")

N_community = vs_arm_subset %>% nrow()

regressionDF_community <- data.frame(
        variable = character(),
        community_adj.rr =  numeric(),
        community_adj.rr_ci = character(), 
        community_adj.rr_p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_catR + genderR + smokingR + educationR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
              family = gaussian, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
 

  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF_community <- rbind(regressionDF_community, temp_row) %>% 
    rename(variable = 1)
  
}  



intDF <- data.frame(
        variable = character(),
        int.p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {
  
  int.m <- geeglm(get(v) ~  site + age_catR + genderR + smokingR + exit_viral_load_suppressed*armR + educationR, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  int.p <- summary(int.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
 
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.character(round(int.p, p_digits)))
  
  intDF <- rbind(intDF, temp_row) %>% 
    rename(variable = 1)
  
  }


regressionDF <- regressionDF_clinic %>% 
  left_join(regressionDF_community, by = "variable") %>% 
  left_join(intDF, by = "variable")
  
names(regressionDF) =
  c("Variable",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value",
    "Adj. Mean Difference ",
    "Adj. 95% CI ",
    "Adj. p-value ",
    "Adj.  p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", paste0("Clinic follow-up, Adjusted \n (N = ", N_clinic, ")"),
                            paste0("Community follow-up, Adjusted \n (N = ", N_community, ")"), 
                             paste0("Interaction \n (N = ", N_community + N_clinic, ")")), 
                 top = T, colwidths = c(1, 3, 3, 1)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 1.75) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

```

### Page Break

## S3, Table 7: Table 3 for the difference in difference in CVD risk


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# Subset to South Africa only!!
# NOTE: we combine the community and hybrid arm (community follow-up), compared to clinic

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" )) 
  
  
round_digits = 2
p_digits = 3

# DROP NA for GEE to run AND RESTRICT TO ART INTITIATORS

vs_subset <- ncd_merged_subset %>% 
  filter(!is.na(exit_viral_load_result)) 

# LINEAR REGRESSIONS -------------------------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_diff", 
    "bmi_diff" ),

  var_label = c(
    "Difference in Systolic BP (mmHg)",
    "Difference in BMI (kg/m^2)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() 
)
 
 
for (v in unique(lin_reg_vars$var_name)) {
  
   # Adjusted for site only
  lm <- geeglm(get(v) ~ site + exit_viral_load_suppressed, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se, 
                coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # 95% CI
  rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE",4]

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~  site + age_catR + genderR + smoking_status + exit_viral_load_suppressed + educationR + baseline_cd4, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(rd_p, p_digits), nsmall = p_digits),
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF <- rbind(regressionDF, temp_row)

}
  
names(regressionDF) =
  c("Variable",
    "Mean Difference",
    "95% CI",
    "p-value",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Unadjusted Analysis", "Adjusted Analysis"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft
```

### Page Break

## S3, Table 8: Table 4 for the difference in difference in CVD risk

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

vs_subset <- ncd_merged_subset %>% filter(!is.na(exit_viral_load_result))

# LINEAR REGRESSIONS -----------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_diff", 
    "bmi_diff" ),

  var_label = c(
    "Difference in Systolic BP (mmHg)",
    "Difference in BMI (kg/m^2)") 
)
  

# COMMUNITY VS. CLINIC FOLLOW-UP

# --- clinic

vs_arm_subset <- vs_subset %>% filter(armR == "Clinic follow-up")

N_clinic = vs_arm_subset %>% nrow()

regressionDF_clinic <- data.frame(
        variable = character(),
        clinic_adj.rr =  numeric(),
        clinic_adj.rr_ci = character(), 
        clinic_adj.rr_p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_catR + genderR + smokingR + educationR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
              family = gaussian, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
 

  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF_clinic <- rbind(regressionDF_clinic, temp_row) %>% 
    rename(variable = 1)
  
}

# --- ccommunity

vs_arm_subset <- vs_subset %>% filter(armR == "Community follow-up")

N_community = vs_arm_subset %>% nrow()

regressionDF_community <- data.frame(
        variable = character(),
        community_adj.rr =  numeric(),
        community_adj.rr_ci = character(), 
        community_adj.rr_p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + site + age_catR + genderR + smokingR + educationR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
              family = gaussian, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
 

  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF_community <- rbind(regressionDF_community, temp_row) %>% 
    rename(variable = 1)
  
}  



intDF <- data.frame(
        variable = character(),
        int.p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {
  
  int.m <- geeglm(get(v) ~  site + age_catR + genderR + smokingR + exit_viral_load_suppressed*armR + educationR, 
              family = gaussian, data = vs_subset,
              id = hhid, corstr = "independence") 
  int.p <- summary(int.m)$coef["exit_viral_load_suppressedTRUE:armRCommunity follow-up",4]
  
 
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.character(round(int.p, p_digits)))
  
  intDF <- rbind(intDF, temp_row) %>% 
    rename(variable = 1)
  
  }


regressionDF <- regressionDF_clinic %>% 
  left_join(regressionDF_community, by = "variable") %>% 
  left_join(intDF, by = "variable")
  
names(regressionDF) =
  c("Variable",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value",
    "Adj. Mean Difference ",
    "Adj. 95% CI ",
    "Adj. p-value ",
    "Adj.  p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", paste0("Clinic follow-up, Adjusted \n (N = ", N_clinic, ")"),
                            paste0("Community follow-up, Adjusted \n (N = ", N_community, ")"), 
                             paste0("Interaction \n (N = ", N_community + N_clinic, ")")), 
                 top = T, colwidths = c(1, 3, 3, 1)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 1.75) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4, 7), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

```


### Page Break

## S3, Table 8: Table 4 for the difference in difference in CVD risk (Not coded correctly???)

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

vs_subset <- ncd_merged_subset %>% filter(!is.na(exit_viral_load_result))

# LINEAR REGRESSIONS -----------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_diff", 
    "bmi_diff" ),

  var_label = c(
    "Difference in Systolic BP (mmHg)",
    "Difference in BMI (kg/m^2)") 
)
  

# NORTHERN VERSUS MIDLANDS

# Notherns

vs_arm_subset <- vs_subset %>% filter(siteR == "Northern KZN SA")

N_clinic = vs_arm_subset %>% filter(!is.na(bmi_diff)) %>%  nrow()

regressionDF_clinic <- data.frame(
        variable = character(),
        clinic_adj.rr =  numeric(),
        clinic_adj.rr_ci = character(), 
        clinic_adj.rr_p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + age_catR + genderR + smokingR + educationR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
              family = gaussian, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
 

  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF_clinic <- rbind(regressionDF_clinic, temp_row) %>% 
    rename(variable = 1)
  
}

# --- ccommunity

vs_arm_subset <- vs_subset %>% filter(siteR == "Midlands KZN SA")

N_community = vs_arm_subset %>% filter(!is.na(bmi_diff))  %>% nrow()

regressionDF_community <- data.frame(
        variable = character(),
        community_adj.rr =  numeric(),
        community_adj.rr_ci = character(), 
        community_adj.rr_p = character()
    )
 
for (v in unique(lin_reg_vars$var_name)) {

  # Adjusted for site, age, gender, smoking 
  
  adj.lm <- geeglm(get(v) ~ exit_viral_load_suppressed + age_catR + genderR + smokingR + educationR, # NOTE THIS SMOKING VARIABLE IS DIFFERENT
              family = gaussian, data = vs_arm_subset,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
 

  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                format(round(adj.rd, round_digits), nsmall = round_digits), 
                paste0("(",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[1], 
                       ",",
                       format(round(adj.rd_ci, round_digits), nsmall = round_digits)[2],
                       ")"),
                format(round(adj.rd_p, p_digits), nsmall = p_digits))
  
  regressionDF_community <- rbind(regressionDF_community, temp_row) %>% 
    rename(variable = 1)
  
}  



regressionDF <- regressionDF_clinic %>% 
  left_join(regressionDF_community, by = "variable") 
  
names(regressionDF) =
  c("Variable",
    "Adj. Mean Difference",
    "Adj. 95% CI",
    "Adj. p-value",
    "Adj. Mean Difference ",
    "Adj. 95% CI ",
    "Adj. p-value ")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", paste0("Northern KZN SA, Adjusted \n (N = ", N_clinic, ")"),
                            paste0("Midlands KZN SA, Adjusted \n (N = ", N_community, ")")), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 1.75) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

```

### Page break

## Appendix S3, EXTRA table: Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline, by site 

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

# Subset to South Africa only and clinic arm only!

ncd_merged_midlands <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" )) %>% 
  filter(site == "HSRC") %>% 
filter(!is.na(exit_viral_load_result)) # DROP NA for GEE to run

ncd_merged_northern <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site,
                       levels = c("HSRC",
                                  "AHRI"))) %>% 
  mutate(armR = case_when(arm == "Clinic arm" ~ "Clinic follow-up",
                          arm == "Community arm" ~ "Community follow-up",
                          arm == "Hybrid arm" ~ "Community follow-up" )) %>% 
  filter(site == "AHRI") %>% 
filter(!is.na(exit_viral_load_result)) # DROP NA for GEE to run

  
round_digits = 2
p_digits = 3

# POISSON REGRESSIONS --------------------------------------------------------------------------

reg_vars <- data.frame(
  
  var_name = c(
    "bp_hi_exit", 
    "overwt_exit", 
    "a1c_hi_exit",
    "smokingR"
   ),

  var_label = c(
    "Elevated BP",
    "Overweight (BMI >= 25)",
    "Elevated blood sugar (a1c >= 5.7)",
    "Current smoker [baseline]"
  ))
  
regressionDF <- data.frame(
        variable = character(),
        rr = numeric(),
        rr_ci = character(),
        rr_p = numeric(),
        adj.rr = character(),
        adj.rr_ci = character(), 
        adj.rr_p = character() 
    )

 
for (v in unique(reg_vars$var_name)) {
  
  if (v != "smokingR") {
    
  # Midlands
  m <- geeglm(get(v) ~ age_catR + genderR + smokingR + educationR + exit_viral_load_suppressed, 
              family = poisson, data = ncd_merged_midlands,
              id = hhid, corstr = "independence") 
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se, 
                  coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI 
  m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
  
  # Northers  
  adj.m <- geeglm(get(v) ~ age_catR + genderR + smokingR + educationR + exit_viral_load_suppressed, 
              family = poisson, data = ncd_merged_northern,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  if (v == "smokingR") {
  
  # Midlands  
  m <- geeglm(get(v) ~ age_catR + genderR + educationR + exit_viral_load_suppressed, 
              family = poisson, data = ncd_merged_midlands,
              id = hhid, corstr = "independence") 
  m.rr <- exp(coef(m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  m.se <- summary(m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  m.rr_ci <- exp(c(coef(m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*m.se, 
                  coef(m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*m.se)) # RR: 95% CI 
  m.p <- summary(m)$coef["exit_viral_load_suppressedTRUE",4]
  
  # Northern
  adj.m <- geeglm(get(v) ~ age_catR + genderR + educationR + exit_viral_load_suppressed, 
              family = poisson, data = ncd_merged_northern,
              id = hhid, corstr = "independence") 
  
  adj.rr <- exp(coef(adj.m)[["exit_viral_load_suppressedTRUE"]]) # Relative Risk
  adj.se <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rr_ci <- exp(c(coef(adj.m)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.se, 
                  coef(adj.m)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.se)) # RR: 95% CI with robust SE
  adj.p <- summary(adj.m)$coef["exit_viral_load_suppressedTRUE",4]
  
  }
  
  temp_row <- c(reg_vars[reg_vars$var_name == v, "var_label"], 
                as.numeric(round(m.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(m.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(m.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(m.p, p_digits)),
                as.numeric(round(adj.rr, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rr_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rr_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)
  
}
  
names(regressionDF) =
  c("Variable",
    "Relative Risk",
    "95% CI",
    "p-value",
    ".Relative Risk",
    ".95% CI",
    ".p-value")

# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Midlands KZN", "Northern KZN"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla() %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft

# LINEAR REGRESSIONS -------------------------------------------------------------------------------

lin_reg_vars <- data.frame(
  
  var_name = c(
    "sbp_mean_exit",
    "dbp_mean_exit", 
    "bmi", 
    "hemoglobin_a1c_result",
    "lipid_result"),

  var_label = c(
    "Systolic blood pressure (mmHg)",
    "Diastolic blood pressure (mmHg)",
    "BMI (kg/m^2)",
    "Hemoglobin A1c (%)",
    "Total cholesterol (mg/dL)") 
)
  

regressionDF <- data.frame(
        variable = character(),
        rd = numeric(),
        rd_ci = character(),
        rd_p = numeric(),
        adj.rd = character(),
        adj.rd_ci = character(), 
        adj.rd_p = character() 
)
 
 
for (v in unique(lin_reg_vars$var_name)) {
  
   # Midlands
  lm <- geeglm(get(v) ~ age_catR + genderR + smokingR + educationR + exit_viral_load_suppressed, 
              family = gaussian, data = ncd_merged_midlands,
              id = hhid, corstr = "independence") 
  rd <- coef(lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  lm.se <- summary(lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  rd_ci <- c(coef(lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*lm.se, 
                coef(lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*lm.se) # 95% CI
  rd_p <- summary(lm)$coef["exit_viral_load_suppressedTRUE",4]

  # Northern
  adj.lm <- geeglm(get(v) ~  age_catR + genderR + smokingR + educationR + exit_viral_load_suppressed, 
              family = gaussian, data = ncd_merged_northern,
              id = hhid, corstr = "independence") 
  adj.rd <- coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] # Mean Difference
  adj.lm.se <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",2] # SE
  adj.rd_ci <- c(coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] - qnorm(0.975)*adj.lm.se, 
                  coef(adj.lm)[["exit_viral_load_suppressedTRUE"]] + qnorm(0.975)*adj.lm.se) # 95% CI
  adj.rd_p <- summary(adj.lm)$coef["exit_viral_load_suppressedTRUE",4]
  
  temp_row <- c(lin_reg_vars[lin_reg_vars$var_name == v, "var_label"], 
                as.numeric(round(rd, round_digits)), 
                paste0("(",
                       as.numeric(round(rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(rd_p, p_digits)),
                as.numeric(round(adj.rd, round_digits)), 
                paste0("(",
                       as.numeric(round(adj.rd_ci, round_digits))[1], 
                       ",",
                       as.numeric(round(adj.rd_ci, round_digits))[2],
                       ")"),
                as.numeric(round(adj.rd_p, p_digits)))
  
  regressionDF <- rbind(regressionDF, temp_row)

}
  
names(regressionDF) =
  c("Variable",
    "Mean Difference",
    "95% CI",
    "p-value",
    ".Mean Difference",
    ".95% CI",
    ".p-value")


# Word Doc output
ft <- flextable(regressionDF) %>% 
  colformat_double(big.mark=",", digits = 1, na_str = "N/A") %>%
  add_header_row(values = c("", "Midlands KZN", "Northern KZN"), 
                 top = T, colwidths = c(1, 3, 3)) %>% 
  width(width = 1.1) %>%
  width(j = 1, width = 2.5) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 4), border = fp_border_default(), part = "all") %>% 
  align(i =1, align = "center", part = "header") 

ft
```




## S4: Additional Figures


## S5 Figure 1: Distribution of clinical CVD measures, by arm [dashed lines are group medians]

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset, "armR")
    
```


### Page Break

## S5 Figure 2: Distribution of cardiovascular risk, by gender [dashed lines are group medians]

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset, "genderR")

```


### Page Break

## S5 Figure 3: Distribution, by VS status at endline [dashed lines are group medians] 

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset, "exit_viral_load_suppressedR")

```

### Page Break

## S5 Figure 4: Distribution, by VS status at endline [dashed lines are group medians] - CLINIC ONLY

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset %>% filter(armR == "Community follow-up"), "exit_viral_load_suppressedR")

```

### Page break

## S5 Figure 5: Distribution, by VS status at endline [dashed lines are group medians] - COMMUNITY ONLY

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset %>% filter(armR == "Community follow-up"), "exit_viral_load_suppressedR")

```

### Page Break

## S5 Figure 6: Distribution of CVD variables by age

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_distribution_figs(ncd_merged_subset, "age", "exit_viral_load_suppressedR")

```

### Page Break

## S5 Figure 7: Distribution of CVD variables by education

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_distribution_figs(ncd_merged_subset, "education", "exit_viral_load_suppressedR")

```