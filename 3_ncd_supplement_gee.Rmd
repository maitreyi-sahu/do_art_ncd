---
title: "DO ART NCD Supplement"
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    reference_docx: word_styles.docx

---

```{r setup, include = F, echo = F, warning = F, message = F}

rm(list=ls())

# Load packages
package.list <- c("plyr", "dplyr", "tidyr", "magrittr", "data.table", "ggplot2",
                  "janitor", "tables", "flextable", "ggpubr", # table formatting
                  "geepack", "sandwich") # regression analysis 
invisible(lapply(package.list, library, character.only = TRUE))

# Load data
dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/DGH+MGH/DO_ART_NCD/"
in_dir <- paste0(dir, "0_data/3_cleaned_data/")

ncd_merged_subset <- readRDS(paste0(in_dir, "ncd_merged_subset.rds")) %>% 
  filter(country == "South Africa") %>% 
  mutate(site = factor (site, levels = c("HSRC", "AHRI")))

# Source functions
source(paste0(dir, "2_code/gee_functions.R"))
source(paste0(dir, "2_code/plot_functions.R"))
```


# Appendix tables 

## S1: Variables Description

+ S1 Codebook (included with main paper)

## S2: Additional Descriptive Statistics

+ S2, Table 1: Change in cardiovascular risk from baseline to endline, by trial arm and gender (AHRI site only, N = 350)
+ S2, Table 2: Descriptive statistics of cardiovascular risk in the DO ART study, by site and including Uganda (N = 1315)
+ S2, Table 3: Descriptive statistics of cardiovascular risk in the DO ART study for South Africa, by viral suppression (N = 1010)
+ S2, EXTRA table: Descriptive statistics of cardiovascular risk in the DO ART Study for South Africa, by ART initiation 

## S3: Additional Analysis

+ S3, Table 1: Table 2 by gender (adjusted only)
+ S3, Table 2: Table 3 by gender (adjusted only)
+ S3, Table 3: Table 4 - men only (adjusted only)
+ S3, Table 4: Table 4 - women only (adjusted only)
+ S3, Table 5: Table 2 by site (adjusted only)
+ S3, Table 6: Table 3 by site (adjusted only)
+ S3, Table 7: Table 4 - Site 1 (adjusted only)
+ S3, Table 8: Table 4 - Site 2 (adjusted only)
+ S3, Table 9: Table 2 restricted to people who initiated ART 
+ S3, Table 10: Table 3 restricted to people who initiated ART 
+ S3, Table 11: Table 4 restricted to people who initiated ART 

## S4: Figures

+ S4 Figure 1: CVD variables, comparing community follow-up with clinic follow-up
+ S4 Figure 2: Distribution of CVD risk by gender
+ S4 Figure 3: Distribution of cardiovascular risk, by viral suppression status at exit 
+ S4 Figure 4: CVD variables, comparing VS versus not - CLINIC FOLLOW-UP GROUP
+ S4 Figure 5: CVD variables, comparing VS versus not - COMMUNITY FOLLOW-UP GROUP
+ S4 Figure 6: CVD variables, by VS and age
+ S4 Figure 7: Distribution of CVD variables by education

### Page Break

## Appendix Table 1: Change in cardiovascular risk from baseline to endline, by trial arm and gender (AHRI site only, N = 350)

&nbsp;


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
# Mean Table
col_headings_mean <- c(
  "Change in CVD risk",
  "Clinic Follow-Up Arm \n Mean (SE)", 
  "Community Follow-Up Arm \n Mean (SE)",
  "Women \n Mean (SE)", 
  "Men \n Mean (SE)",
  "Virally Suppressed at Exit \n Mean (SE)", 
  "Not Virally Suppressed at Exit \n Mean (SE)",
  "Total \n Mean (SE)"
)

table_vars <- data.frame(
  
  var_name = c(D_vars),

  var_label = c(D_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(D_vars) ~ "D"))


  table_subset <- table_vars[table_vars$section=="D", ]
  
  tableDF <- data.frame(
        variable = character(),
        clinic_arm = character(),
        community_arm = character(),
        hybrid_arm = character(),
        vs_true = character(),
        vs_false = character(),
        Women = character(),
        Men = character(),
        Total = character()
    )
  
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset %>% filter(site == "AHRI") # subset to AHRI for this section
    
    m <- geeglm( get(v) ~ 1, 
            family = gaussian, data = data,
            id = hhid, corstr = "independence") 
    
    mean =  round( coef(m)[["(Intercept)"]], round_digits)
    se = round( summary(m)$coef["(Intercept)", 2], round_digits)
    
    result_total = paste0(mean, " (", se, ")")
    
    for (t in unique(data$armR)) {
        
      m <- geeglm( get(v) ~ 1, 
            family = gaussian, data = data %>% filter(armR == t),
            id = hhid, corstr = "independence") 
    
      mean = round( coef(m)[["(Intercept)"]], round_digits)
      se = round( summary(m)$coef["(Intercept)", 2], round_digits)
      
      assign(paste0("result_",t), paste0(mean, " (", se, ")"))
      
    }
    
    for (s in c(T,F)) {
        
      m <- geeglm( get(v) ~ 1, 
            family = gaussian, data = data %>% filter(exit_viral_load_suppressed == s),
            id = hhid, corstr = "independence") 
    
      mean = round( coef(m)[["(Intercept)"]], round_digits)
      se = round( summary(m)$coef["(Intercept)", 2], round_digits)
      
      assign(paste0("result_",s), paste0(mean, " (", se, ")"))
      
    }
    
    
     for (g in unique(data$genderR)) {
        
      m <- geeglm( get(v) ~ 1, 
            family = gaussian, data = data %>%  filter(genderR == g),
            id = hhid, corstr = "independence") 
    
      mean =  round(coef(m)[["(Intercept)"]], round_digits)
      se = round(summary(m)$coef["(Intercept)", 2], round_digits)
      
      assign(paste0("result_",g), paste0(mean, " (", se, ")"))
     }
    
    temp_row = c(table_vars[table_vars$var_name == v, "var_label"],
                 `result_Clinic follow-up` ,
                 `result_Community follow-up`,
                 result_Women,
                 result_Men,
                 result_TRUE,
                 result_FALSE,
                 result_total)
    
    tableDF <- rbind(tableDF, temp_row)
}
  
  # Flextable
  
names(tableDF) <- c("variable", 
                   "clinic_arm", "community_arm",
                    "Women", "Men", 
                   "vs_true", "vs_false",
                    "Total")

ft <- flextable(tableDF) %>%
   
  delete_part(part = "header") %>%
  add_header_row(values = c(col_headings_mean))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  width(width = 1) %>% 
    width(j = 1, width = 2) %>%
  theme_vanilla()  %>% 
  vline(j = c(1, 3, 5, 7), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

```

### Page break

## Appendix Table 2: Descriptive statistics of cardiovascular risk in the DO ART study, by site (N = 1315)

&nbsp;


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
# Set up --------------------------------------------------------------------------

headings <- data.frame(
  section = c("A", "B", "C"),
  title = c( "", 
             "ii) Lifestyle and other risk",
              "iii) Cardiovascular Risk")
)

# A) Demographics
A_vars = c(
  "age_catR","genderR", "educationR"
  )
A_var_labels = c(
  "Age", "Gender", "Education"
  )

# B) Lifestyle and Other Risk (same as above)

# C) Cardiovascular risk (same as above)

table_vars <- data.frame(
  
  var_name = c(A_vars, B_vars, C_vars),

  var_label = c(A_var_labels, B_var_labels, C_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(A_vars) ~ "A",
      var_name %in% c(B_vars) ~ "B",
      var_name %in% c(C_vars) ~ "C")
    )
  

# Descriptive Proportion Table ----------------------------------------------------

col_headings_freq <- c(
  "Category",
  "SW Uganda \n n (%)",
  "Midlands KZN SA \n n (%)", 
  "Northern KZN SA \n n (%)",
  "Total \n n (%)"
  )


for (i in unique(headings$section)) {
  
  table_subset <- table_vars[table_vars$section==i, ]
  
  tableDF <- data.frame(
        variable = character(),
        category = character(),
        sw_uganda = character(),
        midlands_kzn = character(),
        northern_kzn = character(),
        Total = character()
    )
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset 
    
    temp <- data %>% 
      
      # Format table using Janitor package 
      tabyl(!!sym(v), site) %>% 
      adorn_totals(where = "col") %>% 
      adorn_percentages(denominator = "col") %>% 
      adorn_pct_formatting(digits = 0, affix_sign = TRUE) %>% 
      adorn_ns(position = "front") %>%
      as.data.frame() %>% 
      
      # Clean up headers
      rename(category = 1,
             sw_uganda = "ICOBI",
             midlands_kzn = "HSRC",
             northern_kzn = "AHRI") %>% 
      mutate(variable = table_vars[table_vars$var_name == v, "var_label"] ) %>% 
      select(variable, everything())
    
  tableDF <- rbind(tableDF, temp)
  
  }
  
  # Flextable

ft <- flextable(tableDF) %>%
  
  delete_part(part = "header") %>%
  add_header_row(values = c(headings[headings$section == i, "title"], col_headings_freq))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  merge_v(j = "variable") %>%
  width(width = 1.55) %>%
  theme_vanilla() %>% 
  vline(j = c(2, 5), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

rm(temp)  
}
```

### Page break

&nbsp;


## Appendix Table 3: Descriptive statistics of cardiovascular risk in the DO ART study for South Africa, by viral suppression (N = 1010)

&nbsp;


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
headings <- data.frame(
  section = c("A", "B", "C"),
  title = c( "", 
             "ii) Lifestyle and other risk",
              "iii) Cardiovascular Risk")
)

table_vars <- data.frame(
  
  var_name = c(A_vars, B_vars, C_vars),

  var_label = c(A_var_labels, B_var_labels, C_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(A_vars) ~ "A",
      var_name %in% c(B_vars) ~ "B",
      var_name %in% c(C_vars) ~ "C")
    )
  

# Descriptive Proportion Table ----------------------------------------------------

col_headings_freq <- c(
  "Category",
  "Virally suppressed \n n (%)",
  "Not virally suppressed \n n (%)", 
  "VS unknown \n (%)",
  "Total \n n (%)"
  )


for (i in unique(headings$section)) {
  
  table_subset <- table_vars[table_vars$section==i, ]
  
  tableDF <- data.frame(
        variable = character(),
        category = character(),
        vs = character(),
        not_vs = character(),
        vs_unknown = character(),
        Total = character()
    )
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset %>% filter(country == "South Africa")
    
    temp <- data %>% 
      
      # Format table using Janitor package 
      tabyl(!!sym(v), exit_viral_load_suppressedR) %>% 
      adorn_totals(where = "col") %>% 
      adorn_percentages(denominator = "col") %>% 
      adorn_pct_formatting(digits = 0, affix_sign = TRUE) %>% 
      adorn_ns(position = "front") %>%
      as.data.frame() %>% 
      
      # Clean up headers
      rename(category = 1,
             vs = "Yes",
             not_vs = "No",
             vs_unknown = "Missing") %>% 
      mutate(variable = table_vars[table_vars$var_name == v, "var_label"] ) %>% 
      select(variable, everything())
    
  tableDF <- rbind(tableDF, temp)
  
  }
  
  # Flextable

ft <- flextable(tableDF) %>%
  
  delete_part(part = "header") %>%
  add_header_row(values = c(headings[headings$section == i, "title"], col_headings_freq))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  merge_v(j = "variable") %>%
  width(width = 1.55) %>%
  theme_vanilla() %>% 
  vline(j = c(2, 5), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

rm(temp)  
}
```



### Page break


## Appendix Table 4: Descriptive statistics of cardiovascular risk in the DO ART study for South Africa, by ART initiation

&nbsp;


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
# Set up --------------------------------------------------------------------------

table_vars <- data.frame(
  
  var_name = c(A_vars, B_vars, C_vars),

  var_label = c(A_var_labels, B_var_labels, C_var_labels)) %>% 
  
  mutate( 
    
    section = case_when(
      var_name %in% c(A_vars) ~ "A",
      var_name %in% c(B_vars) ~ "B",
      var_name %in% c(C_vars) ~ "C")
    )
  

# Descriptive Proportion Table ----------------------------------------------------

col_headings_freq <- c(
  "Category",
  "Initiated ART \n n (%)",
  "Did not initiate ART \n n (%)", 
  "Total \n n (%)"
  )


for (i in unique(headings$section)) {
  
  table_subset <- table_vars[table_vars$section==i, ]
  
  tableDF <- data.frame(
        variable = character(),
        category = character(),
        init_art = character(),
        not_init_art = character(),
        Total = character()
    )
  
  for (v in unique(table_subset$var_name)) {
      
    data = ncd_merged_subset %>% filter(country == "South Africa")  
    
    temp <- data %>% 
      
      # Format table using Janitor package 
      tabyl(!!sym(v), initiated_art) %>% 
      adorn_totals(where = "col") %>% 
      adorn_percentages(denominator = "col") %>% 
      adorn_pct_formatting(digits = 0, affix_sign = TRUE) %>% 
      adorn_ns(position = "front") %>%
      as.data.frame() %>% 
      
      # Clean up headers
     rename(category = 1,
          init_art = "TRUE",
            not_init_art = "FALSE"
     ) %>% 
      mutate(variable = table_vars[table_vars$var_name == v, "var_label"] ) %>% 
      select(variable, everything())
    
  tableDF <- rbind(tableDF, temp)
  
  }
  
  # Flextable

ft <- flextable(tableDF) %>%
  
  delete_part(part = "header") %>%
  add_header_row(values = c(headings[headings$section == i, "title"], col_headings_freq))  %>%     
  align(i = 1, part = "header", align = "center") %>%
  merge_v(j = "variable") %>%
  width(width = 1.55) %>%
  theme_vanilla() %>% 
  vline(j = c(2, 5), border = fp_border_default(), part = "all")

flextable_to_rmd(ft)  

rm(temp)  
}
```

### Page break

+ S3, Table 1: Table 2 by gender (adjusted only) 
```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
df <- ncd_merged_subset %>% filter(!is.na(exit_viral_load_suppressed))
var_of_interest = "armR"
var_to_pull = "armRCommunity follow-up"
family = "poisson"
strat_var = "genderR"
strat_var_to_pull = "genderRMen"

# POISSON
ft <- get_reg_strat_results(df = df, family = "poisson",
                             var_of_interest = var_of_interest, var_to_pull = var_to_pull,
                             strat_var = strat_var, strat_var_to_pull = strat_var_to_pull)
ft

# LINEAR
ft <- get_reg_strat_results(df = df, family = "gaussian",
                             var_of_interest = var_of_interest, var_to_pull = var_to_pull,
                             strat_var = strat_var, strat_var_to_pull = strat_var_to_pull)
ft

```

+ S3, Table 2: Table 3 by gender (adjusted only) 
```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
df <- ncd_merged_subset %>% filter(!is.na(exit_viral_load_suppressed))
var_of_interest = "exit_viral_load_suppressed"
var_to_pull = "exit_viral_load_suppressedTRUE"
family = "poisson"
strat_var = "genderR"
strat_var_to_pull = "genderRMen"

# POISSON
ft <- get_reg_strat_results(df = df, family = "poisson",
                             var_of_interest = var_of_interest, var_to_pull = var_to_pull,
                             strat_var = strat_var, strat_var_to_pull = strat_var_to_pull)
ft

# LINEAR
ft <- get_reg_strat_results(df = df, family = "gaussian",
                             var_of_interest = var_of_interest, var_to_pull = var_to_pull,
                             strat_var = strat_var, strat_var_to_pull = strat_var_to_pull)
ft

```

+ S3, Table 3: Table 4 - men only (adjusted only)
```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
df <- ncd_merged_subset %>% filter(!is.na(exit_viral_load_suppressed))
var_of_interest = "exit_viral_load_suppressed"
var_to_pull = "exit_viral_load_suppressedTRUE"
family = "poisson"
strat_var = "armR"
strat_var_to_pull = "armRCommunity follow-up"
filter_var = "genderR"
filter_var_level = "Men"

# POISSON
ft <- get_reg_strat_results(df = df, family = "poisson",
                             var_of_interest = var_of_interest, var_to_pull = var_to_pull,
                             strat_var = strat_var, strat_var_to_pull = strat_var_to_pull,
                             filter_var = filter_var, filter_var_level = filter_var_level)
ft

# LINEAR
ft <- get_reg_strat_results(df = df, family = "gaussian",
                             var_of_interest = var_of_interest, var_to_pull = var_to_pull,
                             strat_var = strat_var, strat_var_to_pull = strat_var_to_pull,
                             filter_var = filter_var, filter_var_level = filter_var_level)
ft

```
+ S3, Table 4: Table 4 - women only (adjusted only)
```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}
df <- ncd_merged_subset %>% filter(!is.na(exit_viral_load_suppressed)) 
var_of_interest = "exit_viral_load_suppressed"
var_to_pull = "exit_viral_load_suppressedTRUE"
family = "poisson"
strat_var = "armR"
strat_var_to_pull = "armRCommunity follow-up"
filter_var = "genderR"
filter_var_level = "Women"

# POISSON
ft <- get_reg_strat_results(df = df, family = "poisson",
                             var_of_interest = var_of_interest, var_to_pull = var_to_pull,
                             strat_var = strat_var, strat_var_to_pull = strat_var_to_pull,
                             filter_var = filter_var, filter_var_level = filter_var_level)
ft

# LINEAR
ft <- get_reg_strat_results(df = df, family = "gaussian",
                             var_of_interest = var_of_interest, var_to_pull = var_to_pull,
                             strat_var = strat_var, strat_var_to_pull = strat_var_to_pull,
                             filter_var = filter_var, filter_var_level = filter_var_level)
ft

```

+ S3, Table 5: Table 2 by site (adjusted only)
+ S3, Table 6: Table 3 by site (adjusted only)
+ S3, Table 7: Table 4 - Site 1 (adjusted only)
+ S3, Table 8: Table 4 - Site 2 (adjusted only)
+ S3, Table 9: Table 2 restricted to people who initiated ART 
+ S3, Table 10: Table 3 restricted to people who initiated ART 
+ S3, Table 11: Table 4 restricted to people who initiated ART 


## Appendix S3, Table 2: Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline, by gender

### Page Break

## Appendix S3, Table 6: Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline RESTRICTED TO PEOPLE WHO INITIATIED ART, in South Africa (N = 659).

```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

df <- ncd_merged_subset %>%  filter(initiated_art == T) %>% filter(!is.na(exit_viral_load_result))
```

### Page Break

## Appendix S3, Table 7: Cardiovascular risk among people virally suppressed versus those not virally suppressed at endline RESTICTED TO PEOPLE WHO INITIATIED ART, in South Africa (N = 659).


```{r, echo = F, warning = F, message = F, ft.split = T, ft.keepnext = F, results = 'asis'}

df <- ncd_merged_subset %>%  filter(initiated_art == T) %>% filter(!is.na(exit_viral_load_result))
```

### Page Break

## S4: Additional Figures


## S4 Figure 1: Distribution of clinical CVD measures, by arm [dashed lines are group medians]

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset, "armR")
    
```


### Page Break

## S4 Figure 2: Distribution of cardiovascular risk, by gender [dashed lines are group medians]

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset, "genderR")

```


### Page Break

## S4 Figure 3: Distribution, by VS status at endline [dashed lines are group medians] 

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset, "exit_viral_load_suppressedR")

```

### Page Break

## S4 Figure 4: Distribution, by VS status at endline [dashed lines are group medians] - CLINIC ONLY

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset %>% filter(armR == "Community follow-up"), "exit_viral_load_suppressedR")

```

### Page break

## S4 Figure 5: Distribution, by VS status at endline [dashed lines are group medians] - COMMUNITY ONLY

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_density_figs(ncd_merged_subset %>% filter(armR == "Community follow-up"), "exit_viral_load_suppressedR")

```

### Page Break

## S4 Figure 6: Distribution of CVD variables by age

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_distribution_figs(ncd_merged_subset, "age", "exit_viral_load_suppressedR")

```

### Page Break

## S4 Figure 7: Distribution of CVD variables by education

```{r, echo = F, fig.height = 3.4, fig.width = 10, warning = F, message = F, results = 'hide'}

make_distribution_figs(ncd_merged_subset, "education", "exit_viral_load_suppressedR")

```